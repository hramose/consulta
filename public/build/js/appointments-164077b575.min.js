$(function(){function e(e){e.each(function(){var e={title:$.trim($(this).text()),patient_id:$(this).data("patient")};$(this).data("eventObject",e),$(this).draggable({zIndex:1070,revert:!0,revertDuration:0})})}function t(){$.ajax({type:"GET",url:"/medic/appointments/list",data:{},success:function(e){var t=[];$.each(e,function(e,a){a.allDay=parseInt(a.allDay),0==a.patient_id,t.push(a)}),n(t)},error:function(){}})}function a(){$.ajax({type:"GET",url:"/medic/account/offices/list",data:{},success:function(e){var t=[],a="#00a65a";$.each(e,function(e,n){t.push(n);var r=$("<div />");r.css({"background-color":a,"border-color":a,color:"#fff"}).addClass("external-event"),r.attr("data-patient",0),r.html(""),r.html(n.name),$("#external-events").prepend(r);var i={title:$.trim(n.name),patient_id:0,office_info:JSON.stringify(n)};r.data("eventObject",i),r.draggable({zIndex:1070,revert:!0,revertDuration:0})})},error:function(){}})}function n(e){$("#calendar").fullCalendar({locale:"es",defaultView:"agendaWeek",timeFormat:"h(:mm)a",header:{left:"prev,next today",center:"title",right:"month,agendaWeek,agendaDay"},events:e,forceEventDuration:!0,slotDuration:"00:20:00",defaultTimedEventDuration:"00:20:00",editable:!0,droppable:!0,eventOverlap:!1,businessHours:{dow:[1,2,3,4,5,6],start:"07:00",end:"18:00"},scrollTime:"07:00:00",nowIndicator:!0,timezone:"local",drop:function(e,t){var a=$(this).data("eventObject"),n=$.extend({},a);n.start=e,n.allDay=!1,n.backgroundColor=$(this).css("background-color"),n.borderColor=$(this).css("border-color"),n.overlap=!1;var r=$("#calendar").fullCalendar("renderEvent",n,!0)[0]._id;d(n,r)},eventResize:function(e,t,a){l(e,a)},eventDrop:function(e,t,a){l(e,a)},eventRender:function(e,t){if(t.append("<span class='closeon fa fa-trash'></span>"),t.append("<span class='appointment-details' ></span>"),t.find(".closeon").click(function(){swal({title:"Deseas cancelar la cita?",text:" Requerda que se eliminara del sistema!",type:"warning",showCancelButton:!0,confirmButtonClass:"btn-danger",confirmButtonText:"Si, Cancelar!",closeOnConfirm:!1},function(){c(e._id,e),swal("Cita cancelada!","Tu cita ha sido eliminada.","success")})}),"background"==e.rendering&&t.append("<h3>"+e.title+"</h3>"),t.append('<div data-createdby="'+e.created_by+'"></div>'),e.patient_id&&e.patient)t.find(".appointment-details").click(function(){swal({title:"Cita con el Paciente "+e.patient.first_name+" "+e.patient.last_name,text:"Fecha: "+e.start.format("YYYY-MM-DD")+" De: "+e.start.format("HH:mm")+" a: "+e.end.format("HH:mm"),html:!0})});else{var a="";if(e.office_info){var n=JSON.parse(e.office_info);a="<br>Dirección: "+n.address+", "+n.province+"<br>Teléfono: "+n.phone}t.find(".appointment-details").click(function(){swal({title:e.title,text:"Fecha: "+e.start.format("YYYY-MM-DD")+" De: "+e.start.format("HH:mm")+" a: "+e.end.format("HH:mm")+a,html:!0})})}},dayRender:function(e,t){var a=new Date;e<a&&t.addClass("disabled")},dayClick:function(e,t,a){var n=new Date;return!(e<n)&&($("#myModal").modal({backdrop:"static",show:!0}),void $("#myModal").find("#modal-new-event").attr("data-modaldate",e.format()))}})}function r(e){var t=$("#calendar").fullCalendar("clientEvents");for(i in t)if(e.idRemove!=t[i]._id&&e.end>t[i].start._i&&e.start<t[i].end._i)return!0;return!1}function o(e,t,a,n){$.ajax({type:e||"POST",url:t,data:a,success:function(t){if("POST"==e){if($("#calendar").fullCalendar("removeEvents",a.idRemove),!t)return $("#infoBox").addClass("alert-danger").html("No se pudo crear la consulta!!").show(),void setTimeout(function(){$("#infoBox").removeClass("alert-danger").hide()},3e3);t.allDay=parseInt(t.allDay),t.allDay?c(t.id):$("#calendar").fullCalendar("renderEvent",t,!0)}if("DELETE"==e){if(t)return $("#infoBox").addClass("alert-danger").html("No se puede eliminar consulta ya que se encuentra iniciada!!").show(),void setTimeout(function(){$("#infoBox").removeClass("alert-danger").hide()},3e3);$("#calendar").fullCalendar("removeEvents",a.idRemove)}if("PUT"==e){if(""==t)return $("#infoBox").addClass("alert-danger").html("No se puede cambiar de dia la consulta ya que se encuentra iniciada!!").show(),setTimeout(function(){$("#infoBox").removeClass("alert-danger").hide()},3e3),void n();$("#calendar").fullCalendar("removeEvents",a.id),t.allDay=parseInt(t.allDay),$("#calendar").fullCalendar("renderEvent",t,!0)}},error:function(){}})}function d(e,t){var a={title:e.title,date:e.start.format("YYYY-MM-DD"),start:e.start.stripZone().format(),end:e.end?e.end.stripZone().format():e.start.add(20,"minutes").stripZone().format(),backgroundColor:e.backgroundColor,borderColor:e.borderColor,patient_id:e.patient_id?e.patient_id:0,idRemove:t,office_info:e.office_info?e.office_info:"",allDay:0};r(a)&&(a.allDay=1),o("POST","/medic/appointments",a)}function l(e,t){var a={date:e.start.format("YYYY-MM-DD"),start:e.start.stripZone().format(),end:e.end?e.end.stripZone().format():e.start.add(20,"minutes").stripZone().format(),patient_id:e.patient_id,id:e.id,office_info:e.office_info,allDay:e.allDay};o("PUT","/medic/appointments/"+a.id,a,t)}function c(e){o("DELETE","/medic/appointments/"+e+"/delete",{idRemove:e})}function s(){var t=$("#new-event").val(),a=$(".box-create-appointment").find(".widget-user-2").attr("data-patient"),n=$(".box-create-appointment").find(".widget-user-2").attr("data-title");if(0!=a.length){var r=$("<div />");r.css({"background-color":p,"border-color":p,color:"#fff"}).addClass("external-event"),r.attr("data-patient",a),r.html(""),r.html(t+" - "+n),$("#external-events").prepend(r),e(r),$("#new-event").val(""),$(".search-patients").val("").trigger("change"),$(".search-patients").text("").trigger("change")}}function f(){var e=$("#modal-new-event").val(),t=$(".modal-body").find(".widget-user-2").attr("data-patient"),a=$(".modal-body").find(".widget-user-2").attr("data-title"),n=$.fullCalendar.moment($("#modal-new-event").attr("data-modaldate"));if(0!=t.length){var r={title:$.trim(e+" - "+a),patient_id:t},i=r,o=$.extend({},i);if(o.start=n,n.isValid()){o.allDay=!1,o.backgroundColor=p,o.borderColor=p,o.overlap=!1;var l=$("#calendar").fullCalendar("renderEvent",o,!0)[0]._id;d(o,l)}$("#modal-new-event").val(""),$("#myModal").find("#modal-new-event").attr("data-modaldate",""),$("#myModal").modal("hide")}}var u={Android:function(){return navigator.userAgent.match(/Android/i)},BlackBerry:function(){return navigator.userAgent.match(/BlackBerry/i)},iOS:function(){return navigator.userAgent.match(/iPhone|iPad|iPod/i)},Opera:function(){return navigator.userAgent.match(/Opera Mini/i)},Windows:function(){return navigator.userAgent.match(/IEMobile/i)},any:function(){return u.Android()||u.BlackBerry()||u.iOS()||u.Opera()||u.Windows()}};u.any()&&$(".box-create-appointment").hide(),$(".dropdown-toggle").dropdown(),e($("#external-events div.external-event")),t(),a();var m=new Date,p=(m.getDate(),m.getMonth(),m.getFullYear(),"#3c8dbc");$("#color-chooser-btn");$("#color-chooser > li > a").click(function(e){e.preventDefault(),p=$(this).css("color"),$("#add-new-event").css({"background-color":p,"border-color":p}),$("#modal-add-new-event").css({"background-color":p,"border-color":p})}),$("#new-event").keypress(function(e){13==e.which&&s()}),$("#add-new-event").click(function(e){e.preventDefault(),s()}),$(".search-patients").select2({placeholder:"Buscar paciente",ajax:{url:"/medic/patients/list",dataType:"json",delay:250,data:function(e){return{q:e.term}},processResults:function(e){$(".search-patients").empty();var t=[];return $.each(e.data,function(e,a){item={id:a.id,text:a.first_name},t.push(item)}),{results:t}}}}),$(".btn-finalizar-cita").click(function(e){e.preventDefault(),f()}),$(".modal-search-patients").select2({placeholder:"Buscar paciente",ajax:{url:"/medic/patients/list",dataType:"json",delay:250,data:function(e){return{q:e.term}},processResults:function(e){$(".modal-search-patients").empty();var t=[];return $.each(e.data,function(e,a){item={id:a.id,text:a.first_name},t.push(item)}),{results:t}}}})});