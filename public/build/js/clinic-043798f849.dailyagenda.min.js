$(function(){function a(a){return $.fullCalendar.moment(a).day()}function e(a,e){var t=a.fullCalendar("clientEvents");for(i in t)if(e.idRemove!=t[i]._id&&e.end>t[i].start._i&&e.start<t[i].end._i)return!0;return!1}function t(a){a.each(function(){var a=$(this).find("> div").data("medic");$(this).find("> div").data("office");n(a,[],[])})}function n(e,t,n){var i=$("#calendar-m"+e);c=i.attr("data-minTime")?i.attr("data-minTime"):"06:00:00",f=i.attr("data-maxTime")?i.attr("data-maxTime"):"18:00:00",m=$("#selectSlotDuration").val()?$("#selectSlotDuration").val():i.attr("data-slotDuration"),u=moment.duration(m).asMinutes(),p="minutes",v=i.attr("data-freeDays")?JSON.parse(i.attr("data-freeDays")):[],i.fullCalendar({locale:"es",defaultView:"agendaDay",timeFormat:"h(:mm)a",events:t,forceEventDuration:!0,slotDuration:m,defaultTimedEventDuration:m,editable:!0,droppable:!0,eventOverlap:!1,businessHours:n,eventConstraint:"businessHours",minTime:c,maxTime:f,scrollTime:c,nowIndicator:!0,timezone:"local",allDaySlot:!1,eventReceive:function(a){var e=new Date;return a.start<e?(i.fullCalendar("removeEvents",a._id),!1):void o(i,a,a._id)},eventResize:function(a,e,t,n){r(i,a,t)},eventDrop:function(a,e,t){r(i,a,t)},eventRender:function(a,e){if(e.hasClass("fc-nonbusiness"))return h.addClass("alert-danger").html("Hora no permitida!. No puedes selecionar horas pasadas o fuera del horario de atención").show(),setTimeout(function(){h.removeClass("alert-danger").html("").hide()},3e3),!1;if(e.append("<span class='appointment-details' ></span>"),"background"==a.rendering&&e.append('<span class="title-bg-event">'+a.title+"</span>"),e.append('<div data-createdby="'+a.created_by+'"></div>'),a.patient_id&&a.patient){var t="";if(a.office){var n=a.office;t="en "+n.type+" "+n.name+" <br>Dirección: "+n.address+", "+n.province+', Tel: <a href="tel:'+n.phone+'">'+n.phone+"</a><br>"}e.find(".appointment-details").click(function(){swal({title:"Cita con el Paciente "+a.patient.first_name+" "+a.patient.last_name,html:"Fecha: "+a.start.format("YYYY-MM-DD")+" De: "+a.start.format("HH:mm")+" a: "+a.end.format("HH:mm")+" <br>"+t,showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",cancelButtonText:"Ok",confirmButtonText:"Eliminar cita"}).then(function(){var e=l(i,a._id,a);e&&swal("Cita cancelada!","Tu cita ha sido eliminada del calendario.","success")},function(a){})})}else{var t="",d=a.title,o="Fecha: "+a.start.format("YYYY-MM-DD")+" De: "+a.start.format("HH:mm")+" a: "+a.end.format("HH:mm")+t;if(a.office){var n=a.office;t="<br>Dirección: "+n.address+", "+n.province+" <br>",d="Este horario está reservado para atención en "+n.type+" "+n.name,o="Favor llamar a este número: "+n.phone+" <br> Fecha: "+a.start.format("YYYY-MM-DD")+" De: "+a.start.format("HH:mm")+" a: "+a.end.format("HH:mm")+t}e.find(".appointment-details").click(function(){swal({title:d,html:o,showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",cancelButtonText:"Ok",confirmButtonText:"Eliminar!"}).then(function(){deleteSchedule(a._id,a),swal("Evento eliminado!","Tu evento ha sido eliminado del calendario.","success")},function(a){})})}},dayClick:function(a,e,t){if("month"===t.name)return i.fullCalendar("gotoDate",a),i.fullCalendar("changeView","agendaWeek"),!1;var n=new Date;return a<n||$(e.target).hasClass("fc-nonbusiness")?(h.addClass("alert-danger").html("Hora no permitida!. No puedes selecionar horas pasadas o fuera del horario de atención").show(),setTimeout(function(){h.removeClass("alert-danger").html("").hide()},3e3),!1):!$(e.target).parent("div").hasClass("fc-bgevent")&&(D.modal({backdrop:"static",show:!0}),D.find("#modal-new-event").attr("data-modaldate",a.format()),D.find(".modal-body").attr("data-modaldate",a.format()),D.find(".modal-body").attr("data-date",a.format("dddd, MMMM Do YYYY")).attr("data-hour",a.format("hh:mm a")),void D.find(".modal-body").attr("data-medic",i.data("medic")))},viewRender:function(t){$.ajax({type:"GET",url:"/medics/"+e+"/schedules/list?office="+i.data("office")+"&date1="+t.start.format()+"&date2="+t.end.format(),data:{},success:function(e){var n=[];$.each(e,function(e,t){t.allDay=parseInt(t.allDay);var i={dow:[a(t.date)],start:t.start,end:t.end};n.push(i)});for(var d=n,o=d.length-1;o>=0;o--)moment(d[o].start).isBetween(t.start,t.end)&&(d[o].start=d[o].start.split("T")[1],d[o].end=d[o].end.split("T")[1]);i.fullCalendar("option","businessHours",d)},error:function(a){}}),i.fullCalendar("removeEventSources"),$.ajax({type:"GET",url:"/medics/"+e+"/appointments/list?calendar=1&office="+i.data("office")+"&date1="+t.start.format()+"&date2="+t.end.format(),data:{},success:function(a){var e=[];$.each(a,function(a,t){t.allDay=parseInt(t.allDay),(0!=t.patient_id&&t.office_id!=i.data("office")||0==t.patient_id)&&(t.rendering="background"),e.push(t)}),i.fullCalendar("addEventSource",e)},error:function(a){}})}})}function d(a,e,t,n,i){$("body").addClass("loading"),$.ajax({type:e||"POST",url:t,data:n,success:function(t){if($("body").removeClass("loading"),"POST"==e){if(a.fullCalendar("removeEvents",n.idRemove),!t)return h.addClass("alert-danger").html("No se pudo crear la consulta!!").show(),void setTimeout(function(){h.removeClass("alert-danger").hide()},3e3);t.allDay=parseInt(t.allDay),t.allDay?prog_schedule?deleteSchedule(t.id):l(a,t.id):a.fullCalendar("renderEvent",t,!0)}if("DELETE"==e){if(t)return h.addClass("alert-danger").html("No se puede eliminar consulta ya que se encuentra iniciada!!").show(),setTimeout(function(){h.removeClass("alert-danger").hide()},3e3),t;a.fullCalendar("removeEvents",n.idRemove)}if("PUT"==e){if(""==t)return h.addClass("alert-danger").html("No se puede cambiar de dia la consulta ya que se encuentra iniciada!!").show(),setTimeout(function(){h.removeClass("alert-danger").hide()},3e3),void i();a.fullCalendar("removeEvents",n.id),t.allDay=parseInt(t.allDay),a.fullCalendar("renderEvent",t,!0)}},error:function(){$("body").removeClass("loading")}})}function o(a,t,n){m=a.attr("data-slotDuration"),u=moment.duration(m).asMinutes(),p="minutes";var i={title:t.title,date:t.start.format("YYYY-MM-DD"),start:t.start.stripZone().format(),end:t.end?t.end.stripZone().format():t.start.add(u,p).stripZone().format(),backgroundColor:t.backgroundColor,borderColor:t.borderColor,office_id:t.office_id,patient_id:t.patient_id?t.patient_id:0,user_id:t.user_id,idRemove:n,office_info:t.office_info?t.office_info:"",allDay:0};e(a,i)&&(i.allDay=1),d(a,"POST","/clinic/appointments",i)}function r(a,e,t){m=a.attr("data-slotDuration"),u=moment.duration(m).asMinutes(),p="minutes";var n={date:e.start.format("YYYY-MM-DD"),start:e.start.stripZone().format(),end:e.end?e.end.stripZone().format():e.start.add(u,p).stripZone().format(),patient_id:e.patient_id,id:e.id,office_info:e.office_info,allDay:e.allDay};d(a,"PUT","/clinic/appointments/"+n.id,n,t)}function l(a,e){d(a,"DELETE","/clinic/appointments/"+e+"/delete",{idRemove:e})}function s(){var a="#3c8dbc",e=D.find("#modal-new-event").val(),t=D.find(".modal-body").find(".widget-user-2").attr("data-patient"),n=D.find(".modal-body").find(".widget-user-2").attr("data-title"),i=D.find(".modal-body").find(".widget-user-2").attr("data-office"),d=D.find(".modal-body").attr("data-medic"),r=$.fullCalendar.moment(D.find("#modal-new-event").attr("data-modaldate")),l=D.find("#modal-new-event").attr("data-modaldate-end")?$.fullCalendar.moment(D.find("#modal-new-event").attr("data-modaldate-end")):"",s=$("#calendar-m"+d);if(0!=t.length&&i){var c={title:$.trim(e+" - "+n),user_id:d,patient_id:t,office_id:i},f=c,m=$.extend({},f);if(m.start=r,l&&(m.end=l),r.isValid()){m.allDay=!1,m.backgroundColor=a,m.borderColor=a,m.overlap=!1;var u=s.fullCalendar("renderEvent",m,!0)[0]._id;o(s,m,u)}D.find("#modal-new-event").val(""),D.find("#modal-new-event").attr("data-modaldate",""),D.modal("hide")}}var c="06:00:00",f="18:00:00",m="00:30",u=moment.duration(m).asMinutes(),p="minutes",v=[],h=$("#infoBox"),D=$("#myModal"),C=$(".modal-search-patients");$(".date").datetimepicker({format:"YYYY-MM-DD",locale:"es"}),$(".btn-gotodate").on("click",function(a){var e=$(this).data("mid"),t=$("#go_date_"+e).val();$("#calendar-m"+e).fullCalendar("gotoDate",t)}),t($("td.calendar-medic-day")),D.on("shown.bs.modal",function(a){var e=$(this).find(".modal-body").attr("data-date"),t=$(this).find(".modal-body").attr("data-hour"),n=$(this);n.find(".modal-title").html('Crear cita para el  <span class="label bg-yellow">'+e+'</span> a las <span class="label bg-yellow">'+t+"</span>")}),C.select2({placeholder:"Buscar paciente",ajax:{url:"/medic/patients/list",dataType:"json",delay:250,data:function(a){return{q:a.term}},processResults:function(a){C.empty();var e=[];return $.each(a.data,function(a,t){item={id:t.id,text:t.first_name},e.push(item)}),{results:e}}}}),$(".btn-finalizar-cita").click(function(a){a.preventDefault(),s()}),$(".dropdown-toggle").dropdown()});