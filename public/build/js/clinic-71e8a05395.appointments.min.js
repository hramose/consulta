$(function(){function e(e){var a=C.fullCalendar("clientEvents");for(i in a)if(e.idRemove!=a[i]._id&&e.end>a[i].start._i&&e.start<a[i].end._i)return!0;return!1}function a(e){return $.fullCalendar.moment(e).day()}function t(e){e.each(function(){var e={title:$.trim($(this).text()),office_id:$(this).data("office"),patient_id:$(this).data("patient"),start:moment(),end:moment(),backgroundColor:$(this).css("background-color"),borderColor:$(this).css("border-color")};$(this).data("event",e),$(this).draggable({zIndex:1070,revert:!0,revertDuration:0})})}function n(e,t){c=C.attr("data-minTime")?C.attr("data-minTime"):"06:00:00",f=C.attr("data-maxTime")?C.attr("data-maxTime"):"18:00:00",m=$("#selectSlotDuration").val()?$("#selectSlotDuration").val():C.attr("data-slotDuration"),u=moment.duration(m).asMinutes(),p="minutes",v=C.attr("data-freeDays")?JSON.parse(C.attr("data-freeDays")):[],C.fullCalendar({locale:"es",defaultView:"agendaWeek",timeFormat:"h(:mm)a",header:{left:"prev,next today",center:"title",right:"month,agendaWeek,agendaDay"},events:e,forceEventDuration:!0,slotDuration:m,defaultTimedEventDuration:m,editable:!0,droppable:!0,eventOverlap:!1,businessHours:t,eventConstraint:"businessHours",minTime:c,maxTime:f,scrollTime:c,nowIndicator:!0,timezone:"local",allDaySlot:!1,drop:function(e,a){var t=new Date;if(e<t)return h.addClass("alert-danger").html("Hora no permitida!. No puedes selecionar horas pasadas o fuera del horario de atención").show(),setTimeout(function(){h.removeClass("alert-danger").html("").hide()},3e3),!1;var n=$(this).data("event"),r=$.extend({},n);r.start=e,r.allDay=!1,r.backgroundColor=$(this).css("background-color"),r.borderColor=$(this).css("border-color"),r.overlap=!1},eventReceive:function(e){var a=new Date;return e.start<a?(C.fullCalendar("removeEvents",e._id),!1):void o(e,e._id)},eventResize:function(e,a,t,n){d(e,t)},eventDrop:function(e,a,t){d(e,t)},eventRender:function(e,a){if(a.hasClass("fc-nonbusiness"))return h.addClass("alert-danger").html("Hora no permitida!. No puedes selecionar horas pasadas o fuera del horario de atención").show(),setTimeout(function(){h.removeClass("alert-danger").html("").hide()},3e3),!1;a.append("<span class='appointment-details' ></span>"),"background"==e.rendering&&a.append('<span class="title-bg-event">'+e.title+"</span>"),a.append('<div data-createdby="'+e.created_by+'"></div>');var t=e.start.format("HH:mm"),n=e.end?e.end.format("HH:mm"):"";if(e.patient_id&&e.patient){var r="";if(e.office){var i=e.office;r="en "+i.type+" "+i.name+" <br>Dirección: "+i.address+", "+i.province+', Tel: <a href="tel:'+i.phone+'">'+i.phone+"</a><br>"}a.find(".appointment-details").click(function(){swal({title:"Cita con el Paciente "+e.patient.first_name+" "+e.patient.last_name,html:"Fecha: "+e.start.format("YYYY-MM-DD")+" De: "+t+" a: "+n+" <br>"+r,showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",cancelButtonText:"Ok",confirmButtonText:"Eliminar cita"}).then(function(){var a=l(e._id,e);a&&swal("Cita cancelada!","Tu cita ha sido eliminada del calendario.","success")},function(e){})})}else{var r="",o=e.title,d="Fecha: "+e.start.format("YYYY-MM-DD")+" De: "+t+" a: "+n+r;if(e.office){var i=e.office;r="<br>Dirección: "+i.address+", "+i.province+" <br>",o="Este horario está reservado para atención en "+i.type+" "+i.name,d="Favor llamar a este número: "+i.phone+" <br> Fecha: "+e.start.format("YYYY-MM-DD")+" De: "+t+" a: "+n+r}a.find(".appointment-details").click(function(){swal({title:o,html:d,showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",cancelButtonText:"Ok",confirmButtonText:"Eliminar!"}).then(function(){deleteSchedule(e._id,e),swal("Evento eliminado!","Tu evento ha sido eliminado del calendario.","success")},function(e){})})}},dayClick:function(e,a,t){if("month"===t.name)return C.fullCalendar("gotoDate",e),C.fullCalendar("changeView","agendaWeek"),!1;var n=new Date;return e<n||$(a.target).hasClass("fc-nonbusiness")?(h.addClass("alert-danger").html("Hora no permitida!. No puedes selecionar horas pasadas o fuera del horario de atención").show(),setTimeout(function(){h.removeClass("alert-danger").html("").hide()},3e3),!1):!$(a.target).parent("div").hasClass("fc-bgevent")&&(b.modal({backdrop:"static",show:!0}),b.find("#modal-new-event").attr("data-modaldate",e.format()),b.find(".modal-body").attr("data-modaldate",e.format()),b.find(".modal-body").attr("data-medic",C.attr("data-medic")),void b.find(".modal-body").attr("data-date",e.format("dddd, MMMM Do YYYY")).attr("data-hour",e.format("hh:mm a")))},viewRender:function(e){$.ajax({type:"GET",url:"/medics/"+C.data("medic")+"/schedules/list?office="+C.data("office")+"&date1="+e.start.format()+"&date2="+e.end.format(),data:{},success:function(t){var n=[];$.each(t,function(e,t){t.allDay=parseInt(t.allDay);var r={dow:[a(t.date)],start:t.start,end:t.end};n.push(r)});for(var r=n,i=r.length-1;i>=0;i--)moment(r[i].start).isBetween(e.start,e.end)&&(r[i].start=r[i].start.split("T")[1],r[i].end=r[i].end.split("T")[1]);C.fullCalendar("option","businessHours",r)},error:function(e){}}),C.fullCalendar("removeEventSources"),$.ajax({type:"GET",url:"/medics/"+C.data("medic")+"/appointments/list?calendar=1&office="+C.data("office")+"&date1="+e.start.format()+"&date2="+e.end.format(),data:{},success:function(e){var a=[];$.each(e,function(e,t){t.allDay=parseInt(t.allDay),(0!=t.patient_id&&t.office_id!=C.data("office")||0==t.patient_id)&&(t.rendering="background"),a.push(t)}),C.fullCalendar("addEventSource",a)},error:function(e){}})}})}function r(e,a,t,n){$("body").addClass("loading"),$.ajax({type:e||"POST",url:a,data:t,success:function(a){if($("body").removeClass("loading"),"POST"==e){if(C.fullCalendar("removeEvents",t.idRemove),!a)return h.addClass("alert-danger").html("No se pudo crear la consulta!!").show(),void setTimeout(function(){h.removeClass("alert-danger").hide()},3e3);a.allDay=parseInt(a.allDay),a.allDay?prog_schedule?deleteSchedule(a.id):l(a.id):C.fullCalendar("renderEvent",a,!0)}if("DELETE"==e){if(a)return h.addClass("alert-danger").html("No se puede eliminar consulta ya que se encuentra iniciada!!").show(),setTimeout(function(){h.removeClass("alert-danger").hide()},3e3),a;C.fullCalendar("removeEvents",t.idRemove)}if("PUT"==e){if(""==a)return h.addClass("alert-danger").html("No se puede cambiar de dia la consulta ya que se encuentra iniciada!!").show(),setTimeout(function(){h.removeClass("alert-danger").hide()},3e3),void n();C.fullCalendar("removeEvents",t.id),a.allDay=parseInt(a.allDay),C.fullCalendar("renderEvent",a,!0)}},error:function(){$("body").removeClass("loading")}})}function o(a,t){var n={title:a.title,date:a.start.format("YYYY-MM-DD"),start:a.start.stripZone().format(),end:a.end?a.end.stripZone().format():a.start.add(u,p).stripZone().format(),backgroundColor:a.backgroundColor,borderColor:a.borderColor,office_id:a.office_id,patient_id:a.patient_id?a.patient_id:0,user_id:a.user_id,idRemove:t,office_info:a.office_info?a.office_info:"",allDay:0};e(n)&&(n.allDay=1),r("POST","/clinic/appointments",n)}function d(e,a){var t={date:e.start.format("YYYY-MM-DD"),start:e.start.stripZone().format(),end:e.end?e.end.stripZone().format():e.start.add(u,p).stripZone().format(),patient_id:e.patient_id,id:e.id,office_info:e.office_info,allDay:e.allDay};r("PUT","/clinic/appointments/"+t.id,t,a)}function l(e){r("DELETE","/clinic/appointments/"+e+"/delete",{idRemove:e})}function s(){var e="#3c8dbc",a=b.find("#modal-new-event").val(),t=b.find(".modal-body").find(".widget-user-2").attr("data-patient"),n=b.find(".modal-body").find(".widget-user-2").attr("data-title"),r=b.find(".modal-body").find(".widget-user-2").attr("data-office"),i=C.attr("data-medic"),d=$.fullCalendar.moment(b.find("#modal-new-event").attr("data-modaldate")),l=b.find("#modal-new-event").attr("data-modaldate-end")?$.fullCalendar.moment(b.find("#modal-new-event").attr("data-modaldate-end")):"";if(0!=t.length&&r){var s={title:$.trim(a+" - "+n),user_id:i,patient_id:t,office_id:r},c=s,f=$.extend({},c);if(f.start=d,l&&(f.end=l),d.isValid()){f.allDay=!1,f.backgroundColor=e,f.borderColor=e,f.overlap=!1;var m=C.fullCalendar("renderEvent",f,!0)[0]._id;o(f,m)}b.find("#modal-new-event").val(""),b.find("#modal-new-event").attr("data-modaldate",""),b.modal("hide")}}var c="06:00:00",f="18:00:00",m="00:30",u=moment.duration(m).asMinutes(),p="minutes",v=[],h=$("#infoBox"),C=$("#calendar"),b=$("#myModal"),D=$(".modal-search-patients");t($("#external-events div.external-event")),n([],[]),b.on("shown.bs.modal",function(e){var a=$(this).find(".modal-body").attr("data-date"),t=$(this).find(".modal-body").attr("data-hour"),n=$(this);n.find(".modal-title").html('Crear cita para el  <span class="label bg-yellow">'+a+'</span> a las <span class="label bg-yellow">'+t+"</span>")}),D.select2({placeholder:"Buscar paciente",ajax:{url:"/medic/patients/list",dataType:"json",delay:250,data:function(e){return{q:e.term}},processResults:function(e){D.empty();var a=[];return $.each(e.data,function(e,t){item={id:t.id,text:t.first_name},a.push(item)}),{results:a}}}}),$(".btn-finalizar-cita").click(function(e){e.preventDefault(),s()}),$(".dropdown-toggle").dropdown()});