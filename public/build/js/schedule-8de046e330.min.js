$(function(){function a(a){a.each(function(){var a={title:$.trim($(this).text()),user_id:$(this).data("doctor"),patient_id:$(this).data("patient")};$(this).data("eventObject",a),$(this).draggable({zIndex:1070,revert:!0,revertDuration:0})})}function e(){$.ajax({type:"GET",url:"/medics/"+$(".external-event").data("doctor")+"/appointments/list",data:{},success:function(a){var e=[];$.each(a,function(a,t){t.allDay=parseInt(t.allDay),0!=t.patient_id&&t.created_by!=$(".external-event").data("createdby"),e.push(t)}),t(e)},error:function(){}})}function t(a){$("#calendar").fullCalendar({locale:"es",defaultView:"agendaWeek",timeFormat:"h(:mm)a",header:{left:"prev,next today",center:"title",right:"agendaWeek,agendaDay"},events:a,forceEventDuration:!0,slotDuration:"00:20:00",defaultTimedEventDuration:"00:20:00",editable:!1,droppable:!0,eventOverlap:!1,businessHours:{dow:[1,2,3,4,5,6],start:"07:00",end:"18:00"},scrollTime:"07:00:00",nowIndicator:!0,timezone:"local",allDaySlot:!1,drop:function(a,e){var t=new Date;if(a<t)return $("#infoBox").addClass("alert-danger").html("Hora no permitida!. No puedes selecionar horas pasadas o fuera del horario de atención").show(),setTimeout(function(){$("#infoBox").removeClass("alert-danger").html("").hide()},3e3),!1;var n=$(this).data("eventObject"),r=$.extend({},n);r.start=a,r.allDay=!1,r.backgroundColor=$(this).css("background-color"),r.borderColor=$(this).css("border-color"),r.overlap=!1;var i=$("#calendar").fullCalendar("renderEvent",r,!0)[0]._id;o(r,i)},eventResize:function(a,e,t){d(a,t)},eventDrop:function(a,e,t){d(a,t)},eventRender:function(a,e){if(e.append("<span class='appointment-details' ></span>"),a.created_by==$(".external-event").data("createdby")&&(e.append("<span class='closeon fa fa-trash'></span>"),e.find(".closeon").click(function(){swal({title:"Deseas cancelar la cita?",text:" Requerda que se eliminara del sistema!",type:"warning",showCancelButton:!0,confirmButtonClass:"btn-danger",confirmButtonText:"Si, Cancelar!",closeOnConfirm:!1},function(){l(a._id,a),swal("Cita cancelada!","Tu cita ha sido eliminada.","success")})})),"background"==a.rendering&&e.append("<h3>"+a.title+"</h3>"),e.append('<div data-createdby="'+a.created_by+'"></div>'),e.append('<div data-id="'+a.id+'"></span>'),a.patient_id&&a.patient)a.created_by==$(".external-event").data("createdby")&&e.find(".appointment-details").click(function(){swal({title:"Cita con el Dr. "+a.user.name,text:"Fecha: "+a.start.format("YYYY-MM-DD")+" De: "+a.start.format("HH:mm")+" a: "+a.end.format("HH:mm")+"<br>Paciente: "+a.patient.first_name+" "+a.patient.last_name,html:!0})});else{var t="";if(a.office_info){var n=JSON.parse(a.office_info);t="<br>Dirección: "+n.address+", "+n.province+" <br>Teléfono: "+n.phone}e.find(".appointment-details").click(function(){swal({title:a.title,text:"Fecha: "+a.start.format("YYYY-MM-DD")+" De: "+a.start.format("HH:mm")+" a: "+a.end.format("HH:mm")+t,html:!0})})}},dayRender:function(a,e){},dayClick:function(a,e,t){var n=new Date;return a<n||$(e.target).hasClass("fc-nonbusiness")?($("#infoBox").addClass("alert-danger").html("Hora no permitida!. No puedes selecionar horas pasadas o fuera del horario de atención").show(),setTimeout(function(){$("#infoBox").removeClass("alert-danger").html("").hide()},3e3),!1):($("#myModal").modal({backdrop:"static",show:!0}),$("#myModal").find(".modal-body").attr("data-modaldate",a.format()),void $("#myModal").find(".modal-body").attr("data-date",a.format("dddd, MMMM Do YYYY")).attr("data-hour",a.format("hh:mm a")))}}),$("#calendar").fullCalendar("today")}function n(a){var e=$("#calendar").fullCalendar("clientEvents");for(i in e)if(a.idRemove!=e[i]._id&&a.end>e[i].start._i&&a.start<e[i].end._i)return!0;return!1}function r(a,e,t,n){$.ajax({type:a||"POST",url:e,data:t,success:function(e){if("POST"==a&&($("#calendar").fullCalendar("removeEvents",t.idRemove),e.allDay=parseInt(e.allDay),e.allDay?l(e.id):$("#calendar").fullCalendar("renderEvent",e,!0)),"DELETE"==a){if(e)return $("#infoBox").addClass("alert-danger").html("No se puede eliminar consulta ya que se encuentra iniciada!!").show(),void setTimeout(function(){$("#infoBox").removeClass("alert-danger").hide()},3e3);$("#calendar").fullCalendar("removeEvents",t.idRemove),$("#myModal").find(".btn-finalizar-cita").attr("data-appointment",""),$("#myModal").find(".btn-cancelar-cita").attr("data-appointment","")}if("PUT"==a){if(""==e)return $("#infoBox").addClass("alert-danger").html("No se puede cambiar de dia la consulta ya que se encuentra iniciada!!").show(),setTimeout(function(){$("#infoBox").removeClass("alert-danger").hide()},3e3),void n();$("#calendar").fullCalendar("removeEvents",t.id),e.allDay=parseInt(e.allDay),$("#calendar").fullCalendar("renderEvent",e,!0)}},error:function(){}})}function o(a,e){var t={title:a.title,date:a.start.format("YYYY-MM-DD"),start:a.start.stripZone().format(),end:a.end?a.end.stripZone().format():a.start.add(20,"minutes").stripZone().format(),backgroundColor:a.backgroundColor,borderColor:a.borderColor,user_id:a.user_id,patient_id:a.patient_id?a.patient_id:0,idRemove:e,office_info:a.office_info?a.office_info:"",allDay:0};n(t)&&(t.allDay=1),r("POST","/appointments",t)}function d(a,e){var t={title:a.title,date:a.start.format("YYYY-MM-DD"),start:a.start.stripZone().format(),end:a.end?a.end.stripZone().format():a.start.add(20,"minutes").stripZone().format(),patient_id:a.patient_id,id:a.id,office_info:a.office_info,allDay:a.allDay};r("PUT","/appointments/"+t.id,t,e)}function l(a){r("DELETE","/appointments/"+a+"/delete",{idRemove:a})}function s(){var a=$("div.external-event"),e=$.fullCalendar.moment($(".modal-body").attr("data-modaldate")),t=$("#myModal").find(".widget-user-2").attr("data-patient"),n={title:$.trim(a.text()),user_id:a.data("doctor"),patient_id:t},r=n,i=$.extend({},r);if(i.start=e,e.isValid()){i.allDay=!1,i.backgroundColor=a.css("background-color"),i.borderColor=a.css("border-color"),i.overlap=!1;var d=$("#calendar").fullCalendar("renderEvent",i,!0)[0]._id;o(i,d)}$("#myModal").find(".modal-body").attr("data-modaldate",""),$("#myModal").modal("hide")}var c={Android:function(){return navigator.userAgent.match(/Android/i)},BlackBerry:function(){return navigator.userAgent.match(/BlackBerry/i)},iOS:function(){return navigator.userAgent.match(/iPhone|iPad|iPod/i)},Opera:function(){return navigator.userAgent.match(/Opera Mini/i)},Windows:function(){return navigator.userAgent.match(/IEMobile/i)},any:function(){return c.Android()||c.BlackBerry()||c.iOS()||c.Opera()||c.Windows()}};c.any()&&$(".box-create-appointment").hide(),$(".dropdown-toggle").dropdown(),$("body").on("click",function(a){$('[data-toggle="popover"],[data-original-title]').each(function(){$(this).is(a.target)||0!==$(this).has(a.target).length||0!==$(".popover").has(a.target).length||((($(this).popover("hide").data("bs.popover")||{}).inState||{}).click=!1)})}),a($("#external-events div.external-event")),e();var f=new Date;f.getDate(),f.getMonth(),f.getFullYear();$("#myModal").on("shown.bs.modal",function(a){var e=$(this).find(".modal-body").attr("data-date"),t=$(this).find(".modal-body").attr("data-hour"),n=$(this);n.find(".modal-title").html('Su cita se programará para el  <span class="label bg-yellow">'+e+'</span> a las <span class="label bg-yellow">'+t+"</span>")}),$(".btn-finalizar-cita").on("click",function(a){a.preventDefault(),s()}),$("#myModal").on("click",".btn-cancelar-cita",function(a){})});