$(function(){function t(t,a){return t.toLocaleString()}$(".dropdown-toggle").dropdown();var a=$("#infoBox"),n=$("#modalInvoice");$(".date").datetimepicker({format:"YYYY-MM-DD",locale:"es"}),$("#medic").on("change",function(t){$(this).parents("form").submit()}),$('input[name="pay_with"]').keypress(function(t){if(8!=t.which&&0!=t.which&&(t.which<48||t.which>57))return!1}),$('input[name="pay_with"]').keyup(function(t){var a=parseFloat($(this).val()?$(this).val():0),n=parseFloat($('input[name="total"]').val()),e=0;e=a-n<0?0:a-n,$('input[name="change"]').val(e)}),$(".btn-facturar").on("click",function(t){t.preventDefault();var n=$(this).attr("data-invoice"),e=$(this).attr("data-medic");$(".loader").show(),$("#modalInvoice").find(".callout").addClass("hidden"),$.ajax({type:"PUT",url:"/assistant/invoices/"+n,data:{client_name:$('input[name="client_name"]').val(),client_email:$('input[name="client_email"]').val(),medio_pago:$('select[name="medio_pago"]').val(),condicion_venta:$('select[name="condicion_venta"]').val(),pay_with:$('input[name="pay_with"]').val(),change:$('input[name="change"]').val()},success:function(t){$(".loader").hide(),a.addClass("alert-success").html("Factura procesada!!!").show(),setTimeout(function(){a.removeClass("alert-success").hide()},3e3),swal({title:"Factura procesada!!!",text:"¿Deseas imprimir la factura?",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",cancelButtonText:"No",confirmButtonText:"Si"}).then(function(){$("#rd_ticket").is(":checked")?window.location.href="/assistant/invoices/"+n+"/ticket":window.location.href="/assistant/invoices/"+n+"/print"},function(t){window.location.href="/assistant/medics/"+e+"/invoices"})},error:function(t){$(".loader").hide(),t.responseJSON.errors&&($("#modalInvoice").find(".error-certificate").text(t.responseJSON.errors.certificate[0]),$("#modalInvoice").find(".callout").removeClass("hidden"))}})}),$(".btn-print").on("click",function(t){t.preventDefault();var a=$(this).attr("data-invoice");$(this).attr("data-medic");$("#rd_ticket").is(":checked")?window.location.href="/assistant/invoices/"+a+"/ticket":window.location.href="/assistant/invoices/"+a+"/print"}),n.on("hidden.bs.modal",function(t){var a=$(this),n=a.find("#table-details");n.find("tbody").html(""),a.find("#modal-label-medic").text("")}),n.on("shown.bs.modal",function(a){var n=$(a.relatedTarget),e=$(this),i=n.attr("data-id"),o=n.attr("data-medic"),l=e.find("#table-details"),c="";e.find(".callout").addClass("hidden"),e.find(".btn-facturar").attr("data-invoice",i),e.find(".btn-facturar").attr("data-medic",o),e.find(".btn-print").attr("data-invoice",i),e.find(".btn-print").attr("data-medic",o),$(".loader").show(),$.ajax({type:"GET",url:"/assistant/invoices/"+i+"/details",data:{},success:function(a){$(".loader").hide(),e.find("#modal-label-medic").text(""),l.find("tbody").html("");var n=a.consecutivo;e.find("#modal-label-medic").text(a.medic.name),e.find("#modal-label-patient").text(a.appointment?a.appointment.patient.fullname:""),$('input[name="client_name"]').val(a.client_name?a.client_name:a.appointment.patient.fullname),$('input[name="client_email"]').val(a.client_email?a.client_email:a.appointment.patient.email),$('select[name="medio_pago"]').val(a.medio_pago),$('select[name="condicion_venta"]').val(a.condicion_venta),$('input[name="pay_with"]').val(a.pay_with?a.pay_with:""),$('input[name="change"]').val(a.change),$.each(a.lines,function(a,n){c+="<tr><td>"+n.quantity+"</td><td>"+n.name+"</td><td>"+t(n.amount)+"</td><td>"+t(n.total_line)+"</td></tr>"}),l.find("tbody").html(c),$("#modalInvoiceLabel").html("Factura #"+n+'  <span class="label label-warning pull-right">'+a.created_at+"</span>"),$("#modal-label-total").html("Total: ₡<span>"+t(a.total)+"</span>"),$('input[name="total"]').val(a.total),a.status?(e.find(".btn-print").show(),e.find(".btn-print").focus(),e.find(".btn-facturar").hide(),$('input[name="client_name"]').attr("disabled",!0),$('input[name="client_email"]').attr("disabled",!0),$('select[name="medio_pago"]').attr("disabled",!0),$('select[name="condicion_venta"]').attr("disabled",!0),$(".pay_with_label").html(t(a.pay_with)),$(".change_label").html(t(a.change)),$(".pay_with-field").remove(),$(".change-field").remove(),e.find(".btn-print").attr("data-show","1")):($('input[name="pay_with"]').focus(),e.find(".btn-print").hide(),e.find(".btn-facturar").show())},error:function(){$(".loader").hide()}})})});