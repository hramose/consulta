$(function(){function e(e){e.each(function(){var e={title:$.trim($(this).text()),user_id:$(this).data("doctor"),patient_id:$(this).data("patient"),created_by:$(this).data("createdby")};$(this).data("eventObject",e),$(this).draggable({zIndex:1070,revert:!0,revertDuration:0})})}function a(){$.ajax({type:"GET",url:"/medic/appointments/list",data:{},success:function(e){var a=[];$.each(e,function(e,t){t.allDay=parseInt(t.allDay),0==t.patient_id&&(t.rendering="background"),a.push(t)}),n(a)},error:function(){}})}function t(){$.ajax({type:"GET",url:"/medic/account/offices/list",data:{},success:function(a){var t=[],n="#3c8dbc";$.each(a,function(a,r){t.push(r);var i=$("<div />");i.css({"background-color":n,"border-color":n,color:"#fff"}).addClass("external-event"),i.attr("data-patient",0),i.attr("data-doctor",$("input[name=user_id]").val()),i.html(""),i.html(r.name),$("#external-events").prepend(i),e(i)})},error:function(){}})}function n(e){$("#calendar").fullCalendar({locale:"es",defaultView:"agendaWeek",timeFormat:"h(:mm)a",header:{left:"prev,next today",center:"title",right:"month,agendaWeek,agendaDay"},events:e,forceEventDuration:!0,defaultTimedEventDuration:"01:00:00",editable:!0,droppable:!0,eventOverlap:!1,drop:function(e,a){var t=$(this).data("eventObject"),n=$.extend({},t);n.start=e,n.allDay=!1,n.backgroundColor=$(this).css("background-color"),n.borderColor=$(this).css("border-color"),n.overlap=!1;var r=$("#calendar").fullCalendar("renderEvent",n,!0)[0]._id;d(n,r)},eventResize:function(e,a,t){l(e,t)},eventDrop:function(e,a,t){l(e,t)},eventRender:function(e,a){a.append("<span class='closeon fa fa-trash'></span>"),a.append("<span class='appointment-details' ></span>"),a.find(".closeon").click(function(){c(e._id,e)}),"background"==e.rendering&&a.append("<h3>"+e.title+"</h3>"),a.append('<div data-createdby="'+e.created_by+'"></div>'),e.patient_id&&e.patient&&a.find(".appointment-details").popover({title:"Cita con el Dr. "+e.user.name,placement:"top",html:!0,container:"#calendar",trigger:"click focus",content:"Fecha: "+e.start.format("YYYY-MM-DD")+" <br>De: "+e.start.format("HH:mm")+" a: "+e.end.format("HH:mm")+"<br>Paciente: "+e.patient.first_name+" "+e.patient.last_name})},dayClick:function(e,a,t){$("#myModal").modal({backdrop:"static",show:!0}),$("#myModal").find('input[name="modal-date"]').attr("value",e.format())}})}function r(e){var a=$("#calendar").fullCalendar("clientEvents");for(i in a)if(e.end>a[i].start._i&&e.start<a[i].end._i)return!0;return!1}function o(e,a,t,n){$.ajax({type:e||"POST",url:a,data:t,success:function(a){if("POST"==e&&($("#calendar").fullCalendar("removeEvents",t.idRemove),a.allDay=parseInt(a.allDay),a.allDay?c(a.id):$("#calendar").fullCalendar("renderEvent",a,!0)),"DELETE"==e){if(a)return $("#infoBox").addClass("alert-danger").html("No se puede eliminar consulta ya que se encuentra iniciada!!").show(),void setTimeout(function(){$("#infoBox").removeClass("alert-danger").hide()},3e3);$("#calendar").fullCalendar("removeEvents",t.idRemove)}if("PUT"==e){if(""==a)return $("#infoBox").addClass("alert-danger").html("No se puede cambiar de dia la consulta ya que se encuentra iniciada!!").show(),setTimeout(function(){$("#infoBox").removeClass("alert-danger").hide()},3e3),void n();$("#calendar").fullCalendar("removeEvents",t.id),a.allDay=parseInt(a.allDay),$("#calendar").fullCalendar("renderEvent",a,!0)}},error:function(){}})}function d(e,a){var t={title:e.title,date:e.start.format("YYYY-MM-DD"),start:e.start.format(),end:e.end?e.end.format():e.start.add(1,"hours").format(),backgroundColor:e.backgroundColor,borderColor:e.borderColor,user_id:e.user_id,patient_id:e.patient_id?e.patient_id:0,created_by:e.created_by,idRemove:a,allDay:0};r(t)&&(t.allDay=1),o("POST","/medic/appointments",t)}function l(e,a){var t={subject:e.title,date:e.start.format("YYYY-MM-DD"),start:e.start.format(),end:e.end?e.end.format():e.start.add(1,"hours").format(),backgroundColor:e.backgroundColor,borderColor:e.borderColor,user_id:e.user_id,patient_id:e.patient_id,created_by:e.created_by,id:e.id,allDay:0};o("PUT","/medic/appointments/"+t.id,t,a)}function c(e){o("DELETE","/medic/appointments/"+e+"/delete",{idRemove:e})}function s(){var a=$("#new-event").val(),t=$(".search-patients").val();if(0!=a.length&&0!=t.length){var n=$("<div />");n.css({"background-color":f,"border-color":f,color:"#fff"}).addClass("external-event"),n.attr("data-patient",$(".search-patients").val()),n.attr("data-doctor",$("input[name=user_id]").val()),n.attr("data-createdby",$("input[name=user_id]").val()),n.html(""),n.html(a+" - "+$(".search-patients").text()),$("#external-events").prepend(n),e(n),$("#new-event").val(""),$(".search-patients").val("").trigger("change"),$(".search-patients").text("").trigger("change")}}function u(){var e=$("#modal-new-event").val(),a=$(".modal-search-patients").val();if(0!=e.length&&0!=a.length){var t={title:$.trim(e+" - "+$(".modal-search-patients").text()),user_id:$("input[name=user_id]").val(),patient_id:$(".modal-search-patients").val(),created_by:$("input[name=user_id]").val()},n=t,r=$.extend({},n),i=moment($('input[name="modal-date"]').val());r.start=i,r.allDay=!1,r.backgroundColor=f,r.borderColor=f,r.overlap=!1;var o=$("#calendar").fullCalendar("renderEvent",r,!0)[0]._id;d(r,o),$("#modal-new-event").val(""),$(".modal-search-patients").val("").trigger("change"),$(".modal-search-patients").text("").trigger("change"),$("#myModal").modal("hide")}}var p={Android:function(){return navigator.userAgent.match(/Android/i)},BlackBerry:function(){return navigator.userAgent.match(/BlackBerry/i)},iOS:function(){return navigator.userAgent.match(/iPhone|iPad|iPod/i)},Opera:function(){return navigator.userAgent.match(/Opera Mini/i)},Windows:function(){return navigator.userAgent.match(/IEMobile/i)},any:function(){return p.Android()||p.BlackBerry()||p.iOS()||p.Opera()||p.Windows()}};p.any()&&$(".box-create-appointment").hide(),$(".dropdown-toggle").dropdown(),e($("#external-events div.external-event")),a(),t();var m=new Date,f=(m.getDate(),m.getMonth(),m.getFullYear(),"#3c8dbc");$("#color-chooser-btn");$("#color-chooser > li > a").click(function(e){e.preventDefault(),f=$(this).css("color"),$("#add-new-event").css({"background-color":f,"border-color":f}),$("#modal-add-new-event").css({"background-color":f,"border-color":f})}),$("#new-event").keypress(function(e){13==e.which&&s()}),$("#add-new-event").click(function(e){e.preventDefault(),s()}),$(".search-patients").select2({placeholder:"Buscar paciente",ajax:{url:"/medic/patients/list",dataType:"json",delay:250,data:function(e){return{q:e.term}},processResults:function(e){$(".search-patients").empty();var a=[];return $.each(e.data,function(e,t){item={id:t.id,text:t.first_name},a.push(item)}),{results:a}}}}),$("#modal-add-new-event").click(function(e){e.preventDefault(),u()}),$(".modal-search-patients").select2({placeholder:"Buscar paciente",ajax:{url:"/medic/patients/list",dataType:"json",delay:250,data:function(e){return{q:e.term}},processResults:function(e){$(".modal-search-patients").empty();var a=[];return $.each(e.data,function(e,t){item={id:t.id,text:t.first_name},a.push(item)}),{results:a}}}})});