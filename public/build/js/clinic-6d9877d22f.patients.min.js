$(function(){function e(){$.ajax({type:"GET",url:"/clinic/appointments/list",data:{},success:function(e){s=[],$.each(e,function(e,t){t.allDay=parseInt(t.allDay),s.push(t)})},error:function(e){}})}function t(e){var t=s;for(i in t)if(e.end>t[i].start&&e.start<t[i].end)return!0;return!1}var a={Android:function(){return navigator.userAgent.match(/Android/i)},BlackBerry:function(){return navigator.userAgent.match(/BlackBerry/i)},iOS:function(){return navigator.userAgent.match(/iPhone|iPad|iPod/i)},Opera:function(){return navigator.userAgent.match(/Opera Mini/i)},Windows:function(){return navigator.userAgent.match(/IEMobile/i)},any:function(){return a.Android()||a.BlackBerry()||a.iOS()||a.Opera()||a.Windows()}};a.any()?($(".box-create-appointment").hide(),$(".breadcrumb").hide()):$(".box-search-filters").removeClass("collapsed-box"),$(".dropdown-toggle").dropdown();var n=$("#initAppointment").find(".modal-body").attr("data-slotDuration"),o=moment.duration(n).asMinutes(),r="minutes",d=moment.duration(n).asMinutes();$("#datetimepicker1").datetimepicker({format:"YYYY-MM-DD",locale:"es",defaultDate:new Date}),$("#datetimepicker2").datetimepicker({format:"HH:mm",stepping:d,defaultDate:new Date}),$("#datetimepicker3").datetimepicker({format:"HH:mm",stepping:d,useCurrent:!1}),$("#initAppointment").on("shown.bs.modal",function(e){var t=$(e.relatedTarget),a=t.attr("data-patient"),i=t.attr("data-patientname");$(this).find(".modal-body").find("#patient-name").text(i),$(this).find(".modal-body").attr("data-modalpatient",a)});var s=[];e(),$(".search-offices").select2({placeholder:"Selecciona el Consultorio donde quiere iniciar la consulta",templateResult:function(e){var t=$("<span></span>");return t.text(e.text),e.newOption&&t.css("color","red"),t},ajax:{url:"/clinic/account/offices/list",dataType:"json",delay:250,data:function(e){return{q:e.term}},processResults:function(e){$(".search-offices").empty();var t=[];$.each(e,function(e,a){item={id:a.id,text:a.name,office_info:JSON.stringify(a)},t.push(item)});var a={id:"No disponible",text:"No disponible",office_info:"",newOption:!0};return t.push(a),{results:t}}},templateSelection:function(e){return $(e.element).attr("data-office",e.office_info),e.text}}),$("#initAppointment").find(".add-cita").on("click",function(e){e.preventDefault();var a=$("#initAppointment"),i=a.find(".modal-body").attr("data-modalpatient"),n=a.find("#search-offices").val(),d=a.find('input[name="date"]').val(),s=a.find('input[name="start"]').val(),c=a.find('input[name="end"]').val(),l=d+"T"+s+":00",f=d+"T"+(c?c:s)+":00";if(!n)return $("#initAppointment").find("#search-offices").select2("focus"),$("#initAppointment").find("#search-offices").select2("open"),$("#infoBox").addClass("alert-danger").html("Escribe un consultorio. Por favor revisar!!!").show(),setTimeout(function(){$("#infoBox").removeClass("alert-danger").hide()},3e3),!1;if(!d||!s)return $("#infoBox").addClass("alert-danger").html("Fecha invalida. Por favor revisar!!!").show(),setTimeout(function(){$("#infoBox").removeClass("alert-danger").hide()},3e3),!1;if(moment(l).isAfter(f))return $("#infoBox").addClass("alert-danger").html("Fecha invalida. La hora de inicio no puede ser mayor que la hora final!!!").show(),setTimeout(function(){$("#infoBox").removeClass("alert-danger").hide()},3e3),!1;moment(l).isSame(f)&&(f=moment(l).add(o,r).stripZone().format());var m={title:"Cita",date:d,start:l,end:f,backgroundColor:"#3c8dbc",borderColor:"#3c8dbc",patient_id:i,office_id:n,office_info:"",allDay:0};return t(m)?($("#infoBox").addClass("alert-danger").html("No se puede iniciar esta cita por que ya hay una cita en el mismo horario. Por favor revisa tus citas programadas !!!").show(),setTimeout(function(){$("#infoBox").removeClass("alert-danger").hide()},3e3),!1):void $.ajax({type:"POST",url:"/clinic/appointments",data:m,success:function(e){e.allDay=parseInt(e.allDay),$("#initAppointment").find(".add-cita").attr("disabled","disabled"),$("#initAppointment").find(".btn-cancel").attr("disabled","disabled"),$("#infoBox").addClass("alert-success").html("Cita Creada Correctamente!!. Iniciando su cita, espere un momento").show(),setTimeout(function(){$("#infoBox").removeClass("alert-success").hide(),a.find("#patient-name").text(""),a.find(".modal-body").attr("data-modalpatient",""),a.find("#datetimepicker1").data("DateTimePicker").clear(),a.find("#datetimepicker2").data("DateTimePicker").clear(),a.find("#datetimepicker3").data("DateTimePicker").clear(),a.modal("hide"),$("#initAppointment").find(".add-cita").removeAttr("disabled"),$("#initAppointment").find(".btn-cancel").removeAttr("disabled"),window.location.href="/medic/appointments/"+e.id+"/edit"},3e3)},error:function(){}})})});