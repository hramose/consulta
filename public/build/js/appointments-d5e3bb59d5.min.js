$(function(){function e(e){e.each(function(){var e={title:$.trim($(this).text()),patient_id:$(this).data("patient")};$(this).data("eventObject",e),$(this).draggable({zIndex:1070,revert:!0,revertDuration:0})})}function a(){$.ajax({type:"GET",url:"/medic/appointments/list",data:{},success:function(e){var a=[];$.each(e,function(e,t){t.allDay=parseInt(t.allDay),0==t.patient_id&&(t.rendering="background"),a.push(t)}),o(a)},error:function(){}})}function t(){$.ajax({type:"GET",url:"/medic/account/offices/list",data:{},success:function(e){var a=[],t="#00a65a";$.each(e,function(e,n){a.push(n);var r=$("<div />");r.css({"background-color":t,"border-color":t,color:"#fff"}).addClass("external-event"),r.attr("data-patient",0),r.html(""),r.html(n.name),$("#external-events").prepend(r);var o={title:$.trim(n.name),patient_id:0,office_info:JSON.stringify(n)};r.data("eventObject",o),r.draggable({zIndex:1070,revert:!0,revertDuration:0})})},error:function(){}})}function n(e){$("#datetimepicker2").data("DateTimePicker").clear(),$("#datetimepicker3").data("DateTimePicker").clear(),$("#datetimepicker2").data("DateTimePicker").destroy(),$("#datetimepicker3").data("DateTimePicker").destroy();var a="00"==e.split(":")[1]?e.split(":")[0]:e.split(":")[1];"01"==a&&(a="60"),$("#datetimepicker2").datetimepicker({format:"LT",stepping:a}),$("#datetimepicker3").datetimepicker({format:"LT",stepping:a,useCurrent:!1})}function r(e){k="00"==e.split(":")[1]?e.split(":")[0]:e.split(":")[1],w="00"==e.split(":")[1]?"hours":"minutes",C.fullCalendar("option","slotDuration",e),$.ajax({type:"PUT",url:"/medic/account/settings",data:{slotDuration:e},success:function(e){},error:function(){}})}function o(e){C.fullCalendar({locale:"es",defaultView:"agendaWeek",timeFormat:"h(:mm)a",header:{left:"prev,next today",center:"title",right:"month,agendaWeek,agendaDay"},events:e,forceEventDuration:!0,slotDuration:v,defaultTimedEventDuration:v,editable:!0,droppable:!0,eventOverlap:!1,businessHours:{dow:B,start:D,end:x},minTime:D,maxTime:x,selectable:!0,selectOverlap:!1,selectHelper:!0,scrollTime:D,nowIndicator:!0,timezone:"local",allDaySlot:!1,select:function(e,a,t,n){if("month"===n.name)return $("#calendar").fullCalendar("gotoDate",y),$("#calendar").fullCalendar("changeView","agendaWeek"),!1;var r=new Date;return e<r||$(t.target).hasClass("fc-nonbusiness")?($("#infoBox").addClass("alert-danger").html("Hora no permitida!. No puedes selecionar horas pasadas o fuera del horario de atención").show(),setTimeout(function(){$("#infoBox").removeClass("alert-danger").html("").hide()},3e3),C.fullCalendar("unselect"),!1):($("#myModal").modal({backdrop:"static",show:!0}),$("#myModal").find("#modal-new-event").attr("data-modaldate",e.format()),$("#myModal").find("#modal-new-event").attr("data-modaldate-end",a.format()),$("#myModal").find(".modal-body").attr("data-modaldate",e.format()),$("#myModal").find(".modal-body").attr("data-modaldate-end",a.format()),void $("#myModal").find(".modal-body").attr("data-date",e.format("dddd, MMMM Do YYYY")).attr("data-hour",e.format("hh:mm a")))},drop:function(e,a){var t=$(this).data("eventObject"),n=$.extend({},t);n.start=e,n.allDay=!1,n.backgroundColor=$(this).css("background-color"),n.borderColor=$(this).css("border-color"),n.overlap=!1;var r=$("#calendar").fullCalendar("renderEvent",n,!0)[0]._id;s(n,r)},eventResize:function(e,a,t,n){c(e,t)},eventDrop:function(e,a,t){c(e,t)},eventRender:function(e,a){if(a.hasClass("fc-nonbusiness"))return $("#infoBox").addClass("alert-danger").html("Hora no permitida!. No puedes selecionar horas pasadas o fuera del horario de atención").show(),setTimeout(function(){$("#infoBox").removeClass("alert-danger").html("").hide()},3e3),!1;if(a.append("<span class='appointment-details' ></span>"),"background"==e.rendering&&a.append('<span class="title-bg-event">'+e.title+"</span>"),a.append('<div data-createdby="'+e.created_by+'"></div>'),e.patient_id&&e.patient)a.find(".appointment-details").click(function(){swal({title:"Cita con el Paciente "+e.patient.first_name+" "+e.patient.last_name,text:"Fecha: "+e.start.format("YYYY-MM-DD")+" De: "+e.start.format("HH:mm")+" a: "+e.end.format("HH:mm"),showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",cancelButtonText:"Ok",confirmButtonText:"Eliminar cita"}).then(function(){u(e._id,e),swal("Cita cancelada!","Tu cita ha sido eliminada del calendario.","success")},function(e){})});else{var t="",n=e.title,r="Fecha: "+e.start.format("YYYY-MM-DD")+" De: "+e.start.format("HH:mm")+" a: "+e.end.format("HH:mm")+t;if(e.office_info){var o=JSON.parse(e.office_info);t="<br>Dirección: "+o.address+", "+o.province+" <br>",n="Este horario está reservado para atención en la "+o.type+" "+e.title,r="Favor llamar a este número: "+o.phone+" <br> Fecha: "+e.start.format("YYYY-MM-DD")+" De: "+e.start.format("HH:mm")+" a: "+e.end.format("HH:mm")+t}a.find(".appointment-details").click(function(){swal({title:n,html:r,showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",cancelButtonText:"Ok",confirmButtonText:"Eliminar!"}).then(function(){u(e._id,e),swal("Evento eliminado!","Tu evento ha sido eliminado del calendario.","success")},function(e){})})}},dayClick:function(e,a,t){if("month"===t.name)return $("#calendar").fullCalendar("gotoDate",e),$("#calendar").fullCalendar("changeView","agendaWeek"),!1;var n=new Date;return e<n||$(a.target).hasClass("fc-nonbusiness")?($("#infoBox").addClass("alert-danger").html("Hora no permitida!. No puedes selecionar horas pasadas o fuera del horario de atención").show(),setTimeout(function(){$("#infoBox").removeClass("alert-danger").html("").hide()},3e3),!1):!$(a.target).parent("div").hasClass("fc-bgevent")&&($("#myModal").modal({backdrop:"static",show:!0}),$("#myModal").find("#modal-new-event").attr("data-modaldate",e.format()),$("#myModal").find(".modal-body").attr("data-modaldate",e.format()),void $("#myModal").find(".modal-body").attr("data-date",e.format("dddd, MMMM Do YYYY")).attr("data-hour",e.format("hh:mm a")))}})}function d(e){var a=$("#calendar").fullCalendar("clientEvents");for(i in a)if(e.idRemove!=a[i]._id&&e.end>a[i].start._i&&e.start<a[i].end._i)return!0;return!1}function l(e,a,t,n){$("body").addClass("loading"),$.ajax({type:e||"POST",url:a,data:t,success:function(a){if($("body").removeClass("loading"),"POST"==e){if($("#calendar").fullCalendar("removeEvents",t.idRemove),!a)return $("#infoBox").addClass("alert-danger").html("No se pudo crear la consulta!!").show(),void setTimeout(function(){$("#infoBox").removeClass("alert-danger").hide()},3e3);a.allDay=parseInt(a.allDay),a.allDay?u(a.id):$("#calendar").fullCalendar("renderEvent",a,!0)}if("DELETE"==e){if(a)return $("#infoBox").addClass("alert-danger").html("No se puede eliminar consulta ya que se encuentra iniciada!!").show(),void setTimeout(function(){$("#infoBox").removeClass("alert-danger").hide()},3e3);$("#calendar").fullCalendar("removeEvents",t.idRemove)}if("PUT"==e){if(""==a)return $("#infoBox").addClass("alert-danger").html("No se puede cambiar de dia la consulta ya que se encuentra iniciada!!").show(),setTimeout(function(){$("#infoBox").removeClass("alert-danger").hide()},3e3),void n();$("#calendar").fullCalendar("removeEvents",t.id),a.allDay=parseInt(a.allDay),$("#calendar").fullCalendar("renderEvent",a,!0)}},error:function(){$("body").removeClass("loading")}})}function s(e,a){var t={title:e.title,date:e.start.format("YYYY-MM-DD"),start:e.start.stripZone().format(),end:e.end?e.end.stripZone().format():e.start.add(k,w).stripZone().format(),backgroundColor:e.backgroundColor,borderColor:e.borderColor,patient_id:e.patient_id?e.patient_id:0,idRemove:a,office_info:e.office_info?e.office_info:"",allDay:0};d(t)&&(t.allDay=1),l("POST","/medic/appointments",t)}function c(e,a){var t={date:e.start.format("YYYY-MM-DD"),start:e.start.stripZone().format(),end:e.end?e.end.stripZone().format():e.start.add(k,w).stripZone().format(),patient_id:e.patient_id,id:e.id,office_info:e.office_info,allDay:e.allDay};l("PUT","/medic/appointments/"+t.id,t,a)}function u(e){l("DELETE","/medic/appointments/"+e+"/delete",{idRemove:e})}function m(){var a=$("#new-event").val(),t=$(".box-create-appointment").find(".widget-user-2").attr("data-patient"),n=$(".box-create-appointment").find(".widget-user-2").attr("data-title");if(0!=t.length){var r=$("<div />");r.css({"background-color":_,"border-color":_,color:"#fff"}).addClass("external-event"),r.attr("data-patient",t),r.html(""),r.html(a+" - "+n),$("#external-events").prepend(r),e(r),$("#new-event").val(""),$(".search-patients").val("").trigger("change"),$(".search-patients").text("").trigger("change")}}function p(){var e=$("#modal-new-event").val(),a=$(".modal-body").find(".widget-user-2").attr("data-patient"),t=$(".modal-body").find(".widget-user-2").attr("data-title"),n=$.fullCalendar.moment($("#modal-new-event").attr("data-modaldate")),r=$.fullCalendar.moment($("#modal-new-event").attr("data-modaldate-end"));if(0!=a.length){var o={title:$.trim(e+" - "+t),patient_id:a},i=o,d=$.extend({},i);if(d.start=n,r&&(d.end=r),n.isValid()){d.allDay=!1,d.backgroundColor=_,d.borderColor=_,d.overlap=!1;var l=$("#calendar").fullCalendar("renderEvent",d,!0)[0]._id;s(d,l)}$("#modal-new-event").val(""),$("#myModal").find("#modal-new-event").attr("data-modaldate",""),$("#myModal").modal("hide")}}var h={Android:function(){return navigator.userAgent.match(/Android/i)},BlackBerry:function(){return navigator.userAgent.match(/BlackBerry/i)},iOS:function(){return navigator.userAgent.match(/iPhone|iPad|iPod/i)},Opera:function(){return navigator.userAgent.match(/Opera Mini/i)},Windows:function(){return navigator.userAgent.match(/IEMobile/i)},any:function(){return h.Android()||h.BlackBerry()||h.iOS()||h.Opera()||h.Windows()}},v=$("#setupSchedule").find("#selectSlotDurationModal").val();if(v){var g="00"==v.split(":")[1]?v.split(":")[0]:v.split(":")[1];"01"==g&&(g="60"),$("#datetimepicker1").datetimepicker({format:"YYYY-MM-DD",locale:"es"}),$("#datetimepicker2").datetimepicker({format:"HH:mm",stepping:g}),$("#datetimepicker3").datetimepicker({format:"HH:mm",stepping:g,useCurrent:!1}),$("#setupSchedule").modal({backdrop:"static",show:!0})}h.any()&&($(".box-create-appointment").hide(),$(".box-offices").hide()),$(".dropdown-toggle").dropdown(),e($("#external-events div.external-event")),a(),t();var y=new Date,b=y.getDate(),C=(y.getMonth(),y.getFullYear(),$("#calendar")),D=C.attr("data-minTime")?C.attr("data-minTime"):"06:00:00",x=C.attr("data-maxTime")?C.attr("data-maxTime"):"18:00:00",v=$("#selectSlotDuration").val()?$("#selectSlotDuration").val():C.attr("data-slotDuration"),k="00"==v.split(":")[1]?v.split(":")[0]:v.split(":")[1],w="00"==v.split(":")[1]?"hours":"minutes",T=C.attr("data-freeDays")?JSON.parse(C.attr("data-freeDays")):[0],B=[1,2,3,4,5,6,0];for(b in B)for(f in T)if(T[f]==B[b]){var M=B.indexOf(B[b]);M>-1&&B.splice(M,1)}$("#selectSlotDuration").on("change",function(e){e.preventDefault(),r($(this).val())}),$("#selectSlotDurationModal").on("change",function(e){e.preventDefault(),r($(this).val()),n($(this).val())});var _="#3c8dbc";$("#color-chooser-btn");$("#color-chooser > li > a").click(function(e){e.preventDefault(),_=$(this).css("color"),$("#add-new-event").css({"background-color":_,"border-color":_}),$("#modal-add-new-event").css({"background-color":_,"border-color":_})}),$("#new-event").keypress(function(e){13==e.which&&m()}),$("#add-new-event").click(function(e){e.preventDefault(),m()}),$(".search-patients").select2({placeholder:"Buscar paciente",ajax:{url:"/medic/patients/list",dataType:"json",delay:250,data:function(e){return{q:e.term}},processResults:function(e){$(".search-patients").empty();var a=[];return $.each(e.data,function(e,t){item={id:t.id,text:t.first_name},a.push(item)}),{results:a}}}}),$(".btn-finalizar-cita").click(function(e){e.preventDefault(),p()}),$(".modal-search-patients").select2({placeholder:"Buscar paciente",ajax:{url:"/medic/patients/list",dataType:"json",delay:250,data:function(e){return{q:e.term}},processResults:function(e){$(".modal-search-patients").empty();var a=[];return $.each(e.data,function(e,t){item={id:t.id,text:t.first_name},a.push(item)}),{results:a}}}}),$("#myModal").on("shown.bs.modal",function(e){var a=$(this).find(".modal-body").attr("data-date"),t=$(this).find(".modal-body").attr("data-hour"),n=$(this);n.find(".modal-title").html('Crear cita para el  <span class="label bg-yellow">'+a+'</span> a las <span class="label bg-yellow">'+t+"</span>")}),$(".search-offices").select2({placeholder:"Buscar Consultorios o selecciona no disponible",templateResult:function(e){var a=$("<span></span>");return a.text(e.text),e.newOption&&a.css("color","red"),a},ajax:{url:"/medic/account/offices/list",dataType:"json",delay:250,data:function(e){return{q:e.term}},processResults:function(e){$(".search-offices").empty();var a=[];$.each(e,function(e,t){item={id:t.name,text:t.name,office_info:JSON.stringify(t)},a.push(item)});var t={id:"No disponible",text:"No disponible",office_info:"",newOption:!0};return a.push(t),{results:a}}},templateSelection:function(e){return $(e.element).attr("data-office",e.office_info),e.text}}),$("#setupSchedule").find(".add-cita").on("click",function(e){e.preventDefault();var a=$("#setupSchedule").find("#search-offices").val(),t=$("#setupSchedule").find('input[name="date"]').val(),n=$("#setupSchedule").find('input[name="start"]').val(),r=$("#setupSchedule").find('input[name="end"]').val(),o=a?$("#setupSchedule").find("#search-offices").select2("data"):"",i=o&&o[0].office_info?o[0].office_info:"",l=t+"T"+n,s=t+"T"+r;if(!a)return $("#setupSchedule").find("#search-offices").select2("focus"),$("#setupSchedule").find("#search-offices").select2("open"),$("#infoBox").addClass("alert-danger").html("Escribe un consultorio o evento. Por favor revisar!!!").show(),setTimeout(function(){$("#infoBox").removeClass("alert-danger").hide()},3e3),!1;if(!t||!n||!r)return $("#infoBox").addClass("alert-danger").html("Fecha invalida. Por favor revisar!!!").show(),setTimeout(function(){$("#infoBox").removeClass("alert-danger").hide()},3e3),!1;if(moment(l).isAfter(s))return $("#infoBox").addClass("alert-danger").html("Fecha invalida. La hora de inicio no puede ser mayor que la hora final!!!").show(),setTimeout(function(){$("#infoBox").removeClass("alert-danger").hide()},3e3),!1;var c={title:a,date:t,start:l,end:s,backgroundColor:i?"#00a65a":"#dd4b39",borderColor:i?"#00a65a":"#dd4b39",patient_id:0,office_info:i,allDay:0};return d(c)?($("#infoBox").addClass("alert-danger").html("No se puede agregar el evento por que hay colision de horarios. Por favor revisar!!!").show(),setTimeout(function(){$("#infoBox").removeClass("alert-danger").hide()},3e3),!1):void $.ajax({type:"POST",url:"/medic/appointments",data:c,success:function(e){e.allDay=parseInt(e.allDay),$("#calendar").fullCalendar("renderEvent",e,!0),$("#infoBox").addClass("alert-success").html("Evento Agregado Correctamente!!").show(),setTimeout(function(){$("#infoBox").removeClass("alert-success").hide()},3e3),$("#setupSchedule").find("#search-offices").val([]),$("#setupSchedule").find("#search-offices").text(""),$("#datetimepicker1").data("DateTimePicker").clear(),$("#datetimepicker2").data("DateTimePicker").clear(),$("#datetimepicker3").data("DateTimePicker").clear()},error:function(){}})})});