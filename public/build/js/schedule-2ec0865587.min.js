$(function(){function a(a){a.each(function(){var a={title:$.trim($(this).text()),user_id:$(this).data("doctor"),patient_id:$(this).data("patient"),office_id:$(this).data("office"),start:moment(),end:moment()};$(this).data("event",a),$(this).draggable({zIndex:1070,revert:!0,revertDuration:0})})}function e(){var a=[];$.ajax({type:"GET",url:"/medics/"+$(".external-event").data("doctor")+"/schedules/list?office="+$(".external-event").data("office"),data:{},success:function(e){$.each(e,function(e,n){n.allDay=parseInt(n.allDay);var r={dow:[t(n.date)],start:n.start,end:n.end};a.push(r)}),$.ajax({type:"GET",url:"/medics/"+$(".external-event").data("doctor")+"/appointments/list?office="+$(".external-event").data("office"),data:{},success:function(e){var t=[];$.each(e,function(a,e){e.allDay=parseInt(e.allDay),(0!=e.patient_id&&e.created_by!=$(".external-event").data("createdby")||0==e.patient_id)&&(e.rendering="background"),t.push(e)}),n(t,a)},error:function(a){}})},error:function(a){}})}function t(a){return $.fullCalendar.moment(a).day()}function n(a,e){p.fullCalendar({locale:"es",defaultView:"agendaWeek",timeFormat:"h(:mm)a",header:{left:"prev,next today",center:"title",right:"agendaWeek,agendaDay"},events:a,forceEventDuration:!0,slotDuration:v,defaultTimedEventDuration:v,editable:!1,droppable:!0,eventOverlap:!1,businessHours:e,eventConstraint:"businessHours",minTime:h,maxTime:y,scrollTime:h,nowIndicator:!0,timezone:"local",allDaySlot:!1,drop:function(a,e,t,n){var r=new Date;if(a<r)return $("#infoBox").addClass("alert-danger").html("Hora no permitida!. No puedes selecionar horas pasadas o fuera del horario de atención").show(),setTimeout(function(){$("#infoBox").removeClass("alert-danger").html("").hide()},3e3),!1;var i=$(this).data("event"),o=$.extend({},i);o.start=a,o.allDay=!1,o.backgroundColor=$(this).css("background-color"),o.borderColor=$(this).css("border-color"),o.overlap=!1},eventReceive:function(a){var e=new Date;return a.start<e?($("#calendar").fullCalendar("removeEvents",a._id),!1):void l(a,a._id)},eventResize:function(a,e,t){s(a,t)},eventDrop:function(a,e,t){s(a,t)},eventRender:function(a,e){if(e.append("<span class='appointment-details' ></span>"),"background"==a.rendering&&e.append('<span class="title-bg-event">'+a.title+"</span>"),e.append('<div data-createdby="'+a.created_by+'"></div>'),e.append('<div data-id="'+a.id+'"></span>'),a.patient_id&&a.patient){var t="";if(a.office){var n=a.office;t="en la "+n.type+" "+n.name+" <br>Dirección: "+n.address+", "+n.province+', Tel: <a href="tel:'+n.phone+'">'+n.phone+"</a><br>"}a.created_by==$(".external-event").data("createdby")&&e.find(".appointment-details").click(function(){swal({title:"Cita con el Paciente "+a.patient.first_name+" "+a.patient.last_name,html:"Fecha: "+a.start.format("YYYY-MM-DD")+" De: "+a.start.format("HH:mm")+" a: "+a.end.format("HH:mm")+" <br>"+t,showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",cancelButtonText:"Ok",confirmButtonText:"Eliminar cita"}).then(function(){c(a._id,a),swal("Cita cancelada!","Tu cita ha sido eliminada del calendario.","success")},function(a){})})}else{var t="",r=a.title,i="Fecha: "+a.start.format("YYYY-MM-DD")+" De: "+a.start.format("HH:mm")+" a: "+a.end.format("HH:mm")+t;if(a.office){var n=a.office;t="<br>Dirección: "+n.address+", "+n.province+" <br>",r="Este horario está reservado para atención en la "+n.type+" "+n.name,i='Favor llamar a este número: <a href="tel:'+n.phone+'">'+n.phone+"</a> <br>Fecha: "+a.start.format("YYYY-MM-DD")+" De: "+a.start.format("HH:mm")+" a: "+a.end.format("HH:mm")+t}e.find(".appointment-details").click(function(){swal({title:r,html:i})})}},dayClick:function(a,e,t){var n=new Date;return a<n||$(e.target).hasClass("fc-nonbusiness")?($("#infoBox").addClass("alert-danger").html("Hora no permitida!. No puedes selecionar horas pasadas o fuera del horario de atención").show(),setTimeout(function(){$("#infoBox").removeClass("alert-danger").html("").hide()},3e3),!1):!$(e.target).parent("div").hasClass("fc-bgevent")&&(p.attr("data-appointmentsday")>=2?($("#infoBox").addClass("alert-danger").html("No se puede crear más de dos citas al dia!!").show(),setTimeout(function(){$("#infoBox").removeClass("alert-danger").hide()},3e3),!1):($("#myModal").modal({backdrop:"static",show:!0}),$("#myModal").find(".modal-body").attr("data-modaldate",a.format()),void $("#myModal").find(".modal-body").attr("data-date",a.format("dddd, MMMM Do YYYY")).attr("data-hour",a.format("hh:mm a"))))},viewRender:function(a){$.ajax({type:"GET",url:"/medics/"+$(".external-event").data("doctor")+"/schedules/list?office="+$(".external-event").data("office"),data:{},success:function(e){var n=[];$.each(e,function(a,e){e.allDay=parseInt(e.allDay);var r={dow:[t(e.date)],start:e.start,end:e.end};n.push(r)});for(var r=n,i=r.length-1;i>=0;i--)moment(r[i].start).isBetween(a.start,a.end)&&(r[i].start=r[i].start.split("T")[1],r[i].end=r[i].end.split("T")[1]);$("#calendar").fullCalendar("option","businessHours",r)},error:function(a){}})}}),$("#calendar").fullCalendar("today")}function r(a){var e=$("#calendar").fullCalendar("clientEvents");for(i in e)if(a.idRemove!=e[i]._id&&a.end>e[i].start._i&&a.start<e[i].end._i)return!0;return!1}function o(a,e,t,n){$("body").addClass("loading"),$.ajax({type:a||"POST",url:e,data:t,success:function(e){if($("body").removeClass("loading"),"POST"==a){if($("#calendar").fullCalendar("removeEvents",t.idRemove),"max-per-day"==e)return $("#infoBox").addClass("alert-danger").html("No se puede crear más de dos citas al dia!!").show(),void setTimeout(function(){$("#infoBox").removeClass("alert-danger").hide()},3e3);e.appointment.allDay=parseInt(e.appointment.allDay),e.appointment.allDay?c(e.appointment.id):($("#calendar").fullCalendar("renderEvent",e.appointment,!0),$("#calendar").attr("data-appointmentsday",e.appointmentsToday),$("#modalReminder").modal({backdrop:"static",show:!0}),$("#modalReminder").find(".modal-body").attr("data-appointment",e.appointment.id).show())}if("DELETE"==a){if("error"==e.resp)return $("#infoBox").addClass("alert-danger").html("No se puede eliminar consulta ya que se encuentra iniciada!!").show(),void setTimeout(function(){$("#infoBox").removeClass("alert-danger").hide()},3e3);$("#calendar").fullCalendar("removeEvents",t.idRemove),$("#calendar").attr("data-appointmentsday",e.appointmentsToday),$("#myModal").find(".btn-finalizar-cita").attr("data-appointment",""),$("#myModal").find(".btn-cancelar-cita").attr("data-appointment","")}if("PUT"==a){if(""==e)return $("#infoBox").addClass("alert-danger").html("No se puede cambiar de dia la consulta ya que se encuentra iniciada!!").show(),setTimeout(function(){$("#infoBox").removeClass("alert-danger").hide()},3e3),void n();$("#calendar").fullCalendar("removeEvents",t.id),e.allDay=parseInt(e.allDay),$("#calendar").fullCalendar("renderEvent",e,!0)}},error:function(){$("body").removeClass("loading")}})}function l(a,e){var t={title:a.title,date:a.start.format("YYYY-MM-DD"),start:a.start.stripZone().format(),end:a.end?a.end.stripZone().format():a.start.add(b,g).stripZone().format(),backgroundColor:a.backgroundColor,borderColor:a.borderColor,user_id:a.user_id,patient_id:a.patient_id?a.patient_id:0,office_id:a.office_id?a.office_id:0,idRemove:e,office_info:a.office_info?a.office_info:"",allDay:0};r(t)&&(t.allDay=1),o("POST","/appointments",t)}function s(a,e){var t={title:a.title,date:a.start.format("YYYY-MM-DD"),start:a.start.stripZone().format(),end:a.end?a.end.stripZone().format():a.start.add(b,g).stripZone().format(),patient_id:a.patient_id,office_id:a.office_id,id:a.id,office_info:a.office_info,allDay:a.allDay};o("PUT","/appointments/"+t.id,t,e)}function c(a){o("DELETE","/appointments/"+a+"/delete",{idRemove:a})}function m(){var a=$("div.external-event"),e=$.fullCalendar.moment($(".modal-body").attr("data-modaldate")),t=$("#myModal").find(".widget-user-2").attr("data-patient"),n={title:$.trim(a.text()),user_id:a.data("doctor"),patient_id:t,office_id:a.data("office")},r=n,i=$.extend({},r);if(i.start=e,e.isValid()){i.allDay=!1,i.backgroundColor=a.css("background-color"),i.borderColor=a.css("border-color"),i.overlap=!1;var o=$("#calendar").fullCalendar("renderEvent",i,!0)[0]._id;l(i,o)}$("#myModal").find(".modal-body").attr("data-modaldate",""),$("#myModal").modal("hide")}var u={Android:function(){return navigator.userAgent.match(/Android/i)},BlackBerry:function(){return navigator.userAgent.match(/BlackBerry/i)},iOS:function(){return navigator.userAgent.match(/iPhone|iPad|iPod/i)},Opera:function(){return navigator.userAgent.match(/Opera Mini/i)},Windows:function(){return navigator.userAgent.match(/IEMobile/i)},any:function(){return u.Android()||u.BlackBerry()||u.iOS()||u.Opera()||u.Windows()}};u.any()&&$(".box-create-appointment").hide(),$(".dropdown-toggle").dropdown(),a($("#external-events div.external-event")),e();var p=$("#calendar"),v=p.attr("data-slotDuration")?p.attr("data-slotDuration"):"00:30:00",h=p.attr("data-minTime")?p.attr("data-minTime"):"06:00:00",y=p.attr("data-maxTime")?p.attr("data-maxTime"):"18:00:00",b="00"==v.split(":")[1]?v.split(":")[0]:v.split(":")[1],g="00"==v.split(":")[1]?"hours":"minutes",D=p.attr("data-freeDays")?JSON.parse(p.attr("data-freeDays")):[0],C=[1,2,3,4,5,6,0];for(d in C)for(f in D)if(D[f]==C[d]){var x=C.indexOf(C[d]);x>-1&&C.splice(x,1)}$("#myModal").on("shown.bs.modal",function(a){var e=$(this).find(".modal-body").attr("data-date"),t=$(this).find(".modal-body").attr("data-hour"),n=$(this);n.find(".modal-title").html('Su cita se programará para el  <span class="label bg-yellow">'+e+'</span> a las <span class="label bg-yellow">'+t+"</span>")}),$(".btn-finalizar-cita").on("click",function(a){a.preventDefault(),m()}),$(".btn-finalizar-reminder").on("click",function(a){a.preventDefault();var e=$("#modalReminder").find(".modal-body").attr("data-appointment"),t=$("#modalReminder").find("#reminder_time").val();$("body").addClass("loading"),$.ajax({type:"POST",url:"/appointments/"+e+"/reminder",data:{reminder_time:t},success:function(a){$("body").removeClass("loading"),$("#modalReminder").modal("hide")},error:function(){$("body").removeClass("loading"),$("#modalReminder").modal("hide")}})}),$(".fc-button-prev span").click(function(){alert("prev is clicked, do something")}),$(".fc-button-next span").click(function(){alert("nextis clicked, do something")})});