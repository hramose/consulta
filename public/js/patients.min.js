$(function(){function e(e){var t=u;for(i in t)if(e.end>t[i].start&&e.start<t[i].end)return!0;return!1}function t(e){r.fullCalendar({locale:"es",defaultView:"month",timeFormat:"h(:mm)a",header:{left:"prev,next ",center:"title",right:""},events:e,timezone:"local",allDaySlot:!1,eventRender:function(e,t){var n=e.office?e.office.id:"",i=e.office?e.office.name:"",r=i+" De: "+e.start.format("HH:mm")+" a: "+e.end.format("HH:mm");t.append('<span class="appointment-details tooltip" data-office="'+n+'" data-officename="'+i+'" data-toggle="tooltip" title="'+r+'"></span>'),"background"==e.rendering&&t.append('<span class="title-bg-event" data-title="'+e.title+'">'+e.title+"</span>"),t.find(".appointment-details").click(function(){d.empty(),$(".schedule-clinic").text(i),schedule=e;for(var t,n,r,s,l,f=a(moment(schedule.start).format("YYYY-MM-DD"),moment(schedule.start).format("HH:mm"),moment(schedule.end).format("HH:mm"),c),m="Disponible",u=0;u<f.length-1;u++){t=moment(schedule.start).format("YYYY-MM-DD")+"T"+f[u]+":00",n=moment(schedule.start).format("YYYY-MM-DD")+"T"+f[u+1]+":00",l=o(t,n),l.res?1==l.res?(m="No Disponible",r=1):(m="Reservado",r=2,s=l.id):(m="Disponible",r=0);var p=f[u]+":00",h=f[u+1]+":00";d.append('<option value="'+schedule.office_id+'" data-date="'+moment(schedule.start).format("YYYY-MM-DD")+'" data-office="'+schedule.office_id+'" data-start="'+t+'" data-end="'+n+'"> '+p+" - "+h+"</option>")}d.prepend('<option value="" selected><span style="color:red;">--</span></option>')})},dayClick:function(e,t,a){},viewRender:function(e){r.fullCalendar("removeEventSources"),$.ajax({type:"GET",url:"/medic/appointments/list?calendar=1&date1="+e.start.format()+"&date2="+e.end.format(),data:{},success:function(e){u=[],$.each(e,function(e,t){t.allDay=parseInt(t.allDay),0==t.patient_id&&(t.rendering="background"),u.push(t)})},error:function(e){}}),$.ajax({type:"GET",url:"/medic/schedules/list?date1="+e.start.format()+"&date2="+e.end.format(),data:{},success:function(e){var t=[];$.each(e,function(e,a){a.allDay=parseInt(a.allDay),t.push(a)}),r.fullCalendar("addEventSource",t)},error:function(e){}})}})}function a(e,t,a,i){a=Date.parse(e+" "+a),t=Date.parse(e+" "+t);for(var o=i?i:30,r=60/o,d=36e5,s=Math.abs(a-t)/d*r,l=new Date(t),c=[],f=0;f<=s;f++){var m=n(l.getHours()),u=n(l.getMinutes());c.push(m+":"+u),l.setMinutes(l.getMinutes()+o)}return c}function n(e){return e<10?"0"+e:e}function o(e,t){for(var a={res:0,id:0},n=0;n<u.length;n++)u[n].end>e&&u[n].start<t&&(a.res=1,a.id=u[n].id);return a}var r=$("#miniCalendar"),d=$("#schedule-list"),s={Android:function(){return navigator.userAgent.match(/Android/i)},BlackBerry:function(){return navigator.userAgent.match(/BlackBerry/i)},iOS:function(){return navigator.userAgent.match(/iPhone|iPad|iPod/i)},Opera:function(){return navigator.userAgent.match(/Opera Mini/i)},Windows:function(){return navigator.userAgent.match(/IEMobile/i)},any:function(){return s.Android()||s.BlackBerry()||s.iOS()||s.Opera()||s.Windows()}};s.any()?($(".box-create-appointment").hide(),$(".breadcrumb").hide()):$(".box-search-filters").removeClass("collapsed-box"),$("form[data-confirm]").submit(function(){if(!confirm($(this).attr("data-confirm")))return!1}),$(".dropdown-toggle").dropdown();var l=$("#initAppointment").find(".modal-body").attr("data-slotDuration"),c=moment.duration(l).asMinutes(),f="minutes",m=moment.duration(l).asMinutes();$("#datetimepicker1").datetimepicker({format:"YYYY-MM-DD",locale:"es",defaultDate:new Date}),$("#datetimepicker2").datetimepicker({format:"HH:mm",stepping:m,defaultDate:new Date}),$("#datetimepicker3").datetimepicker({format:"HH:mm",stepping:m,useCurrent:!1}),$("#initAppointment").on("shown.bs.modal",function(e){var t=$(e.relatedTarget),a=t.attr("data-patient"),n=t.attr("data-patientname");$(this).find(".modal-body").find("#patient-name").text(n),$(this).find(".modal-body").attr("data-modalpatient",a),r.fullCalendar("render")});var u=[];$(".search-offices").select2({placeholder:"Selecciona el Consultorio donde quiere iniciar la consulta",ajax:{url:"/medic/account/offices/list",dataType:"json",delay:250,data:function(e){return{q:e.term}},processResults:function(e){$(".search-offices").empty();var t=[];return $.each(e,function(e,a){item={id:a.id,text:a.name,office_info:JSON.stringify(a)},t.push(item)}),{results:t}}},templateSelection:function(e){return $(e.element).attr("data-office",e.office_info),e.text}}),$("#initAppointment").find(".add-cita").on("click",function(t){t.preventDefault();var a=$("#initAppointment"),n=a.find(".modal-body").attr("data-modalpatient"),i=a.find('input[name="office_id"]').val(),o=a.find('input[name="date"]').val(),r=a.find('input[name="start"]').val(),d=a.find('input[name="end"]').val();if(!i)return $("#initAppointment").find("#search-offices").select2("focus"),$("#initAppointment").find("#search-offices").select2("open"),$("#infoBox").addClass("alert-danger").html("Selecciona un consultorio dentro del calendario. Por favor revisar!!!").show(),setTimeout(function(){$("#infoBox").removeClass("alert-danger").hide()},3e3),!1;if(!o||!r)return $("#infoBox").addClass("alert-danger").html("Fecha invalida. Por favor revisar!!!").show(),setTimeout(function(){$("#infoBox").removeClass("alert-danger").hide()},3e3),!1;if(moment(r).isAfter(d))return $("#infoBox").addClass("alert-danger").html("Fecha invalida. La hora de inicio no puede ser mayor que la hora final!!!").show(),setTimeout(function(){$("#infoBox").removeClass("alert-danger").hide()},3e3),!1;moment(r).isSame(d)&&(d=moment(r).add(c,f).stripZone().format());var s={title:"Cita",date:o,start:r,end:d,backgroundColor:"#3c8dbc",borderColor:"#3c8dbc",patient_id:n,office_id:i,office_info:"",allDay:0};return e(s)?($("#infoBox").addClass("alert-danger").html("No se puede iniciar esta cita por que ya hay una cita en el mismo horario. Por favor revisa tus citas programadas !!!").show(),setTimeout(function(){$("#infoBox").removeClass("alert-danger").hide()},3e3),!1):void $.ajax({type:"POST",url:"/medic/appointments",data:s,success:function(e){e.allDay=parseInt(e.allDay),$("#initAppointment").find(".add-cita").attr("disabled","disabled"),$("#initAppointment").find(".btn-cancel").attr("disabled","disabled"),$("#infoBox").addClass("alert-success").html("Cita Creada Correctamente!!. Iniciando su cita, espere un momento").show(),setTimeout(function(){$("#infoBox").removeClass("alert-success").hide(),a.find("#patient-name").text(""),a.find(".modal-body").attr("data-modalpatient",""),a.modal("hide"),$("#initAppointment").find(".add-cita").removeAttr("disabled"),$("#initAppointment").find(".btn-cancel").removeAttr("disabled"),window.location.href="/medic/appointments/"+e.id+"/edit"},3e3)},error:function(){}})}),t([]),d.change(function(){var e=$(this).find("option:selected");$('input[name="start"]').val(e.data("start")),$('input[name="end"]').val(e.data("end")),$('input[name="date"]').val(e.data("date")),$('input[name="office_id"]').val(e.data("office"))})});