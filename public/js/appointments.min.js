$(function(){function e(e){return $.fullCalendar.moment(e).day()}function a(e){N.data("DateTimePicker").clear(),F.data("DateTimePicker").clear(),N.data("DateTimePicker").destroy(),F.data("DateTimePicker").destroy();var a=N.datetimepicker({format:"LT",stepping:a});F.datetimepicker({format:"LT",stepping:a,useCurrent:!1})}function t(e){k=moment.duration(e).asMinutes(),T="minutes",E.attr("data-slotduration",e),E.fullCalendar("option","slotDuration",e),$.ajax({type:"PUT",url:"/medic/account/settings",data:{slotDuration:e},success:function(e){window.location.href="/medic/appointments/create?wizard=1"},error:function(){}})}function n(e){var a=E.fullCalendar("clientEvents");for(i in a)if(e.idRemove!=a[i]._id&&!a[i].rendering&&e.end>a[i].start._i&&e.start<a[i].end._i)return!0;return!1}function r(e){e.each(function(){var e={title:$.trim($(this).text()),office_id:$(this).data("office"),patient_id:$(this).data("patient"),start:moment(),end:moment(),backgroundColor:$(this).css("background-color"),borderColor:$(this).css("border-color")};$(this).data("event",e),$(this).draggable({zIndex:1070,revert:!0,revertDuration:0})})}function o(){$.ajax({type:"GET",url:"/medic/account/offices/list",data:{},success:function(e){var a=[],t=["#00c0ef","#00a65a","#f39c12","#dd4b39","#A9D300"];$.each(e,function(e,n){var r=t[e];r||(r="#00c0ef"),a.push(n);var i=$("<div />");i.css({"background-color":r,"border-color":r,color:"#fff"}).addClass("external-event"),i.attr("data-patient",0),i.html(""),i.html(n.name),$("#external-offices").prepend(i);var o={title:$.trim(n.name),office_id:n.id,office_info:JSON.stringify(n),backgroundColor:i.css("background-color"),borderColor:i.css("border-color")};i.data("event",o),i.draggable({zIndex:1070,revert:!0,revertDuration:0})})},error:function(e){}})}function l(a){b=E.attr("data-minTime")?E.attr("data-minTime"):"06:00:00",y=E.attr("data-maxTime")?E.attr("data-maxTime"):"18:00:00",w=$("#selectSlotDuration").val()?$("#selectSlotDuration").val():E.attr("data-slotDuration"),k=moment.duration(w).asMinutes(),T="minutes",Y=E.attr("data-freeDays")?JSON.parse(E.attr("data-freeDays")):[],_=[1,2,3,4,5,6,0];for(d in _)for(f in Y)if(Y[f]==_[d]){var t=_.indexOf(_[d]);t>-1&&_.splice(t,1)}E.fullCalendar({locale:"es",defaultView:"agendaWeek",timeFormat:"h(:mm)a",header:{left:"prev,next today",center:"title",right:"month,agendaWeek,agendaDay"},events:a,forceEventDuration:!0,slotDuration:w,defaultTimedEventDuration:w,editable:!0,droppable:!0,eventOverlap:!1,businessHours:{dow:_,start:b,end:y},eventConstraint:"businessHours",minTime:b,maxTime:y,scrollTime:b,nowIndicator:!0,timezone:"local",allDaySlot:!1,select:function(e,a,t,n){if("month"===n.name)return E.fullCalendar("gotoDate",date),E.fullCalendar("changeView","agendaWeek"),!1;var r=new Date;return e<r||$(t.target).hasClass("fc-nonbusiness")?(P.addClass("alert-danger").html("Hora no permitida!. No puedes selecionar horas pasadas o fuera del horario de atención").show(),setTimeout(function(){P.removeClass("alert-danger").html("").hide()},3e3),E.fullCalendar("unselect"),!1):(B.modal({backdrop:"static",show:!0}),B.find("#modal-new-event").attr("data-modaldate",e.format()),B.find("#modal-new-event").attr("data-modaldate-end",a.format()),B.find(".modal-body").attr("data-modaldate",e.format()),B.find(".modal-body").attr("data-modaldate-end",a.format()),void B.find(".modal-body").attr("data-date",e.format("dddd, MMMM Do YYYY")).attr("data-hour",e.format("hh:mm a")))},drop:function(e,a){var t=new Date;if(e<t)return P.addClass("alert-danger").html("Hora no permitida!. No puedes selecionar horas pasadas o fuera del horario de atención").show(),setTimeout(function(){P.removeClass("alert-danger").html("").hide()},3e3),!1;var n=$(this).data("event"),r=$.extend({},n);r.start=e,r.allDay=!1,r.backgroundColor=$(this).css("background-color"),r.borderColor=$(this).css("border-color"),r.overlap=!1},eventReceive:function(e){var a=new Date;return e.start<a?(E.fullCalendar("removeEvents",e._id),!1):void(S?m(e,e._id):h(e,e._id))},eventResize:function(e,a,t,n){S?u(e,t):v(e,t)},eventDrop:function(e,a,t){S?u(e,t):v(e,t)},eventRender:function(e,a){if(a.hasClass("fc-nonbusiness"))return P.addClass("alert-danger").html("Hora no permitida!. No puedes selecionar horas pasadas o fuera del horario de atención").show(),setTimeout(function(){P.removeClass("alert-danger").html("").hide()},3e3),!1;var t=e.office?e.office.id:"",n=e.office?e.office.name:"",r=e.start.format("HH:mm"),i=e.end?e.end.format("HH:mm"):"";if(a.append('<span class="appointment-details" data-office="'+t+'" data-officename="'+n+'"></span>'),"background"==e.rendering&&a.append('<span class="title-bg-event" data-title="'+e.title+'">'+e.title+"</span>"),a.append('<div data-createdby="'+e.created_by+'"></div>'),e.patient_id&&e.patient){var o="";if(e.office){var d=e.office;o="en "+d.type+" "+d.name+" <br>Dirección: "+d.address+", "+d.province+', Tel: <a href="tel:'+d.phone+'">'+d.phone+"</a><br>"}a.find(".appointment-details").click(function(){swal({title:"Cita con el Paciente "+e.patient.first_name+" "+e.patient.last_name,html:"Fecha: "+e.start.format("YYYY-MM-DD")+" De: "+r+" a: "+i+" <br>"+o,showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",cancelButtonText:"Ok",confirmButtonText:"Eliminar cita"}).then(function(){var a=g(e._id,e);a&&swal("Cita cancelada!","Tu cita ha sido eliminada del calendario.","success")},function(e){})})}else if(!e.schedule){var o="",l=e.title,s="Fecha: "+e.start.format("YYYY-MM-DD")+" De: "+r+" a: "+i+o;if(e.office){var d=e.office;o="<br>Dirección: "+d.address+", "+d.province+" <br>",l="Este horario está reservado para atención en "+d.type+" "+d.name,s="Favor llamar a este número: "+d.phone+" <br> Fecha: "+e.start.format("YYYY-MM-DD")+" De: "+r+" a: "+i+o}a.find(".appointment-details").click(function(){swal({title:l,html:s,showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",cancelButtonText:"Ok",confirmButtonText:"Eliminar!"}).then(function(){p(e._id,e),swal("Evento eliminado!","Tu evento ha sido eliminado del calendario.","success")},function(e){})})}},dayClick:function(e,a,t){if("month"===t.name)return E.fullCalendar("gotoDate",e),E.fullCalendar("changeView","agendaWeek"),!1;var n=new Date;return e<n||$(a.target).hasClass("fc-nonbusiness")?(P.addClass("alert-danger").html("Hora no permitida!. No puedes selecionar horas pasadas o fuera del horario de atención").show(),setTimeout(function(){P.removeClass("alert-danger").html("").hide()},3e3),!1):($(a.target).parent("div").hasClass("fc-bgevent"),void(S?(I.data("DateTimePicker").date(e),N.data("DateTimePicker").date(e.format("HH:mm ")),x.modal({backdrop:"static",show:!0})):(B.modal({backdrop:"static",show:!0}),B.find("#modal-new-event").attr("data-modaldate",e.format()),B.find(".modal-body").attr("data-modaldate",e.format()),B.find(".modal-body").attr("data-date",e.format("dddd, MMMM Do YYYY")).attr("data-hour",e.format("hh:mm a")),B.find(".modal-body").attr("data-office",$(a.target).data("office")),B.find(".modal-body").attr("data-officename",$(a.target).data("officename")))))},viewRender:function(a){E.fullCalendar("removeEventSources"),S?$.ajax({type:"GET",url:"/medic/schedules/list?date1="+a.start.format()+"&date2="+a.end.format(),data:{},success:function(e){var a=[];$.each(e,function(e,t){t.allDay=parseInt(t.allDay),a.push(t)}),E.fullCalendar("addEventSource",a)},error:function(e){}}):($.ajax({type:"GET",url:"/medic/appointments/list?calendar=1&date1="+a.start.format()+"&date2="+a.end.format(),data:{},success:function(e){var a=[];$.each(e,function(e,t){t.allDay=parseInt(t.allDay),0==t.patient_id&&(t.rendering="background"),a.push(t)}),E.fullCalendar("addEventSource",a)},error:function(e){}}),$.ajax({type:"GET",url:"/medic/schedules/list?date1="+a.start.format()+"&date2="+a.end.format(),data:{},success:function(t){var n=[],r=$(".schedule-list"),i=$("#currentWeek");i.html("<b>"+a.start.format()+" | "+a.end.format()+"</b>"),r.html("");var o=[];$.each(t,function(a,t){t.allDay=parseInt(t.allDay),t.rendering="background",t.schedule=1,n.push(t);var i='<li><span class="label label-warning">'+moment(t.date).format("dddd")+" "+moment(t.start).format("HH:mm")+"-"+moment(t.end).format("HH:mm")+"</span> "+t.office.name+"</li>";r.append(i);var d={dow:[e(t.date)],start:t.start,end:t.end};o.push(d)});for(var d=o.length-1;d>=0;d--)moment(o[d].start).isBetween(a.start,a.end)&&(o[d].start=o[d].start.split("T")[1],o[d].end=o[d].end.split("T")[1]);E.fullCalendar("option","businessHours",o),E.fullCalendar("addEventSource",n)},error:function(e){}}))}})}function s(e){H.fullCalendar({locale:"es",defaultView:"month",timeFormat:"h(:mm)a",header:{left:"prev,next ",center:"title",right:""},events:e,timezone:"local",allDaySlot:!1,eventRender:function(e,a){var t=e.start.format("HH:mm"),n=e.end?e.end.format("HH:mm"):"",r=e.office?e.office.id:"",i=e.office?e.office.name:"",o=i+" De: "+t+" a: "+n;a.append('<span class="appointment-details tooltip" data-office="'+r+'" data-officename="'+i+'" data-toggle="tooltip" title="'+o+'"></span>'),"background"==e.rendering&&a.append('<span class="title-bg-event" data-title="'+e.title+'">'+e.title+"</span>"),a.find(".appointment-details").click(function(){E.fullCalendar("gotoDate",e.date)})},dayClick:function(e,a,t){},viewRender:function(e){H.fullCalendar("removeEventSources"),$.ajax({type:"GET",url:"/medic/schedules/list?date1="+e.start.format()+"&date2="+e.end.format(),data:{},success:function(e){var a=[];$.each(e,function(e,t){t.allDay=parseInt(t.allDay),a.push(t)}),H.fullCalendar("addEventSource",a)},error:function(e){}})}})}function c(e,a,t,n){$(".loader").show(),$.ajax({type:e||"POST",url:a,data:t,success:function(a){if($(".loader").hide(),"POST"==e){if(E.fullCalendar("removeEvents",t.idRemove),!a)return P.addClass("alert-danger").html("No se pudo crear la consulta!!").show(),void setTimeout(function(){P.removeClass("alert-danger").hide()},3e3);a.allDay=parseInt(a.allDay),a.allDay?S?p(a.id):g(a.id):E.fullCalendar("renderEvent",a,!0),t.redirect_appointment&&(window.location.href="/medic/appointments/"+a.id+"/edit")}if("DELETE"==e){if(a)return P.addClass("alert-danger").html("No se puede eliminar consulta ya que se encuentra iniciada!!").show(),setTimeout(function(){P.removeClass("alert-danger").hide()},3e3),a;E.fullCalendar("removeEvents",t.idRemove)}if("PUT"==e){if(""==a)return P.addClass("alert-danger").html("No se puede cambiar de dia la consulta ya que se encuentra iniciada!!").show(),setTimeout(function(){P.removeClass("alert-danger").hide()},3e3),void n();E.fullCalendar("removeEvents",t.id),a.allDay=parseInt(a.allDay),E.fullCalendar("renderEvent",a,!0)}},error:function(){$(".loader").hide()}})}function m(e,a){var t={title:e.title,date:e.start.format("YYYY-MM-DD"),start:e.start.stripZone().format(),end:e.end?e.end.stripZone().format():e.start.add(k,T).stripZone().format(),backgroundColor:e.backgroundColor,borderColor:e.borderColor,office_id:e.office_id?e.office_id:0,idRemove:a,office_info:e.office_info?e.office_info:"",allDay:0};n(t)&&(t.allDay=1),c("POST","/medic/schedules",t)}function u(e,a){var t={date:e.start.format("YYYY-MM-DD"),start:e.start.stripZone().format(),end:e.end?e.end.stripZone().format():e.start.add(k,T).stripZone().format(),office_id:e.office_id,id:e.id,office_info:e.office_info,allDay:e.allDay};c("PUT","/medic/schedules/"+t.id,t,a)}function p(e){c("DELETE","/medic/schedules/"+e+"/delete",{idRemove:e})}function h(e,a,t){var r={title:e.title,date:e.start.format("YYYY-MM-DD"),start:e.start.stripZone().format(),end:e.end?e.end.stripZone().format():e.start.add(k,T).stripZone().format(),backgroundColor:e.backgroundColor,borderColor:e.borderColor,office_id:e.office_id,patient_id:e.patient_id?e.patient_id:0,idRemove:a,office_info:e.office_info?e.office_info:"",allDay:0,redirect_appointment:t};n(r)&&(r.allDay=1),c("POST","/medic/appointments",r)}function v(e,a){var t={date:e.start.format("YYYY-MM-DD"),start:e.start.stripZone().format(),end:e.end?e.end.stripZone().format():e.start.add(k,T).stripZone().format(),patient_id:e.patient_id,id:e.id,office_info:e.office_info,allDay:e.allDay};c("PUT","/medic/appointments/"+t.id,t,a)}function g(e){c("DELETE","/medic/appointments/"+e+"/delete",{idRemove:e})}function D(){var e=$("#new-event").val(),a=R.find(".widget-user-2").attr("data-patient"),t=R.find(".widget-user-2").attr("data-office"),n=R.find(".widget-user-2").attr("data-title");if(0!=a.length&&t){var i=$("<div />");i.css({"background-color":O,"border-color":O,color:"#fff"}).addClass("external-event"),i.attr("data-patient",a),i.attr("data-office",t),i.html(""),i.html(e+" - "+n),$("#external-events").prepend(i),r(i),$("#new-event").val(""),j.val("").trigger("change"),j.text("").trigger("change")}}function C(e){var a=B.find("#modal-new-event").val(),t=B.find(".modal-body").find(".widget-user-2").attr("data-patient"),n=B.find(".modal-body").find(".widget-user-2").attr("data-title"),r=B.find(".modal-body").find(".widget-user-2").attr("data-office"),i=$.fullCalendar.moment(B.find("#modal-new-event").attr("data-modaldate")),o=B.find("#modal-new-event").attr("data-modaldate-end")?$.fullCalendar.moment(B.find("#modal-new-event").attr("data-modaldate-end")):"";if(r||(r=B.find(".modal-body").attr("data-office")),0!=t.length&&r){var d={title:$.trim(a+" - "+n),patient_id:t,office_id:r},l=d,s=$.extend({},l);if(s.start=i,o&&(s.end=o),i.isValid()){s.allDay=!1,s.backgroundColor=O,s.borderColor=O,s.overlap=!1;var c=E.fullCalendar("renderEvent",s,!0)[0]._id;h(s,c,e)}B.find("#modal-new-event").val(""),B.find("#modal-new-event").attr("data-modaldate",""),B.modal("hide")}}var b="06:00:00",y="18:00:00",w="00:30",k=moment.duration(w).asMinutes(),T="minutes",Y=[],_=[1,2,3,4,5,6,0],x=$("#setupSchedule"),M=x.find("#selectSlotDurationModal").val(),E=$("#calendar"),H=$("#miniCalendar"),S=E.attr("data-schedule")?E.attr("data-schedule"):"",P=$("#infoBox"),B=$("#myModal"),O="#3c8dbc",R=$(".box-create-appointment"),j=$(".search-patients"),A=$(".modal-search-patients"),Z=$(".search-offices"),I=$("#datetimepicker1"),N=$("#datetimepicker2"),F=$("#datetimepicker3"),q=$("#datetimepickerini1"),z=$("#datetimepickerini2"),W=$("#datetimepickerfin1"),L=$("#datetimepickerfin2"),G={Android:function(){return navigator.userAgent.match(/Android/i)},BlackBerry:function(){return navigator.userAgent.match(/BlackBerry/i)},iOS:function(){return navigator.userAgent.match(/iPhone|iPad|iPod/i)},Opera:function(){return navigator.userAgent.match(/Opera Mini/i)},Windows:function(){return navigator.userAgent.match(/IEMobile/i)},any:function(){return G.Android()||G.BlackBerry()||G.iOS()||G.Opera()||G.Windows()}};if(G.any()&&($(".box-create-appointment").hide(),$(".box-offices").hide()),$(".dropdown-toggle").dropdown(),M){var V=moment.duration(M).asMinutes();I.datetimepicker({format:"YYYY-MM-DD",locale:"es",defaultDate:new Date}),N.datetimepicker({format:"HH:mm",stepping:V}),F.datetimepicker({format:"HH:mm",stepping:V,useCurrent:!1}),x.modal({backdrop:"static",show:!0})}$("#selectSlotDuration").on("change",function(e){e.preventDefault(),t($(this).val())}),$("#selectSlotDurationModal").on("change",function(e){e.preventDefault(),t($(this).val()),a($(this).val())}),q.datetimepicker({format:"YYYY-MM-DD",locale:"es",defaultDate:new Date}),z.datetimepicker({format:"YYYY-MM-DD",locale:"es",defaultDate:new Date}),W.datetimepicker({format:"YYYY-MM-DD",locale:"es",defaultDate:new Date}),L.datetimepicker({format:"YYYY-MM-DD",locale:"es",defaultDate:new Date}),r($("#external-events div.external-event")),o();l([]),s([]),j.select2({placeholder:"Buscar paciente",ajax:{url:"/medic/patients/list",dataType:"json",delay:250,data:function(e){return{q:e.term}},processResults:function(e){j.empty();var a=[];return $.each(e.data,function(e,t){item={id:t.id,text:t.first_name},a.push(item)}),{results:a}}}}),B.on("shown.bs.modal",function(e){var a=$(this).find(".modal-body").attr("data-date"),t=$(this).find(".modal-body").attr("data-hour"),n=$(this).find(".modal-body").attr("data-officename"),r=$(this);r.find(".modal-title").html('Crear cita para el  <span class="label bg-yellow">'+a+'</span> a las <span class="label bg-yellow">'+t+'</span> en <span class="label bg-yellow">'+n+"</span>")}),A.select2({placeholder:"Buscar paciente",ajax:{url:"/medic/patients/list",dataType:"json",delay:250,data:function(e){return{q:e.term}},processResults:function(e){A.empty();var a=[];return $.each(e.data,function(e,t){item={id:t.id,text:t.first_name},a.push(item)}),{results:a}}}}),Z.select2({placeholder:"Buscar Consultorios o Clínicas privadas",ajax:{url:"/medic/account/offices/list",dataType:"json",delay:250,data:function(e){return{q:e.term}},processResults:function(e){Z.empty();var a=[];return $.each(e,function(e,t){item={id:t.id,text:t.name,office_info:JSON.stringify(t)},a.push(item)}),{results:a}}},templateSelection:function(e){return $(e.element).attr("data-office",e.office_info),e.text}}),x.find(".add-cita").on("click",function(e){e.preventDefault();var a=x.find("#search-offices").text(),t=x.find("#search-offices").val(),r=x.find('input[name="date"]').val(),i=x.find('input[name="start"]').val(),o=x.find('input[name="end"]').val(),d=a?x.find("#search-offices").select2("data"):"",l=d&&d[0].office_info?d[0].office_info:"",s=r+"T"+i+":00",c=r+"T"+(o?o:i)+":00";if(!a)return x.find("#search-offices").select2("focus"),x.find("#search-offices").select2("open"),P.addClass("alert-danger").html("Escribe un consultorio o clínica. Por favor revisar!!!").show(),setTimeout(function(){P.removeClass("alert-danger").hide()},3e3),!1;if(!r||!i)return P.addClass("alert-danger").html("Fecha invalida. Por favor revisar!!!").show(),setTimeout(function(){P.removeClass("alert-danger").hide()},3e3),!1;if(moment(s).isAfter(c))return P.addClass("alert-danger").html("Fecha invalida. La hora de inicio no puede ser mayor que la hora final!!!").show(),setTimeout(function(){P.removeClass("alert-danger").hide()},3e3),!1;moment(s).isSame(c)&&(c=moment(s).add(k,T).stripZone().format());var f=["#2A630F","#558D00","#77B000","#8CCC00","#A9D300"],m=f[Math.floor(Math.random()*f.length)],u={title:a,date:r,start:s,end:c,backgroundColor:m,borderColor:m,office_id:t,office_info:l,allDay:0};return n(u)?(P.addClass("alert-danger").html("No se puede agregar el evento por que hay colision de horarios. Por favor revisar!!!").show(),setTimeout(function(){P.removeClass("alert-danger").hide()},3e3),!1):void $.ajax({type:"POST",url:"/medic/schedules",data:u,success:function(e){e.allDay=parseInt(e.allDay),E.fullCalendar("renderEvent",e,!0),P.addClass("alert-success").html("Horario Agregado Correctamente!!").show(),setTimeout(function(){P.removeClass("alert-success").hide()},3e3),x.find("#search-offices").val([]),x.find("#search-offices").text(""),I.data("DateTimePicker").clear(),N.data("DateTimePicker").clear(),F.data("DateTimePicker").clear()},error:function(){}})}),$("#new-event").keypress(function(e){13==e.which&&D()}),$("#add-new-event").click(function(e){e.preventDefault(),D()}),$(".btn-finalizar-cita").click(function(e){e.preventDefault(),C()}),$(".btn-iniciar-cita").click(function(e){e.preventDefault();var a=1;C(a)})});