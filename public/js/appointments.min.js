$(function(){function e(e){e.each(function(){var e={title:$.trim($(this).text()),user_id:$(this).data("doctor"),patient_id:$(this).data("patient")};$(this).data("eventObject",e),$(this).draggable({zIndex:1070,revert:!0,revertDuration:0})})}function t(){$.ajax({type:"GET",url:"/medic/appointments/list",data:{},success:function(e){var t=[];$.each(e,function(e,a){a.allDay=!1,0==a.patient_id&&(a.rendering="background"),t.push(a)}),n(t)},error:function(){}})}function a(){$.ajax({type:"GET",url:"/medic/account/offices/list",data:{},success:function(t){var a=[],n="#3c8dbc";$.each(t,function(t,r){a.push(r);var o=$("<div />");o.css({"background-color":n,"border-color":n,color:"#fff"}).addClass("external-event"),o.attr("data-patient",0),o.attr("data-doctor",$("input[name=user_id]").val()),o.html(""),o.html(r.name),$("#external-events").prepend(o),e(o)})},error:function(){}})}function n(e){$("#calendar").fullCalendar({locale:"es",defaultView:"agendaWeek",timeFormat:"h(:mm)a",header:{left:"prev,next today",center:"title",right:"month,agendaWeek,agendaDay"},events:e,forceEventDuration:!0,editable:!0,droppable:!0,eventOverlap:!1,drop:function(e,t){var a=$(this).data("eventObject"),n=$.extend({},a);n.start=e,n.allDay=t,n.backgroundColor=$(this).css("background-color"),n.borderColor=$(this).css("border-color"),n.overlap=!1;var r=$("#calendar").fullCalendar("renderEvent",n,!0)[0]._id;d(n,r),$(this).data("patient")&&$(this).remove()},eventResize:function(e,t,a){c(e,a)},eventDrop:function(e,t,a){c(e,a)},eventRender:function(e,t){t.append("<span class='closeon fa fa-trash'></span>"),t.find(".closeon").click(function(){l(e._id,e)}),"background"==e.rendering&&t.append("<h3>"+e.title+"</h3>")}})}function r(e){var t=$("#calendar").fullCalendar("clientEvents");for(i in t)if(e.end>=t[i].start&&e.start<=t[i].end)return!0;return!1}function o(e,t,a,n){$.ajax({type:e||"POST",url:t,data:a,success:function(t){if("POST"==e&&($("#calendar").fullCalendar("removeEvents",a.idRemove),r(a)&&(t.allDay=!0),$("#calendar").fullCalendar("renderEvent",t,!0)),"DELETE"==e){if(t)return $("#infoBox").addClass("alert-danger").html("No se puede eliminar consulta ya que se encuentra iniciada!!").show(),void setTimeout(function(){$("#infoBox").removeClass("alert-danger").hide()},3e3);$("#calendar").fullCalendar("removeEvents",a.idRemove)}if("PUT"==e&&""==t)return $("#infoBox").addClass("alert-danger").html("No se puede cambiar de dia la consulta ya que se encuentra iniciada!!").show(),setTimeout(function(){$("#infoBox").removeClass("alert-danger").hide()},3e3),void n()},error:function(){}})}function d(e,t){var a={title:e.title,date:e.start.format("YYYY-MM-DD"),start:e.start.format(),end:e.end?e.end.format():e.start.add(2,"hours").format(),backgroundColor:e.backgroundColor,borderColor:e.borderColor,user_id:e.user_id,patient_id:e.patient_id?e.patient_id:0,idRemove:t};o("POST","/medic/appointments",a)}function c(e,t){var a={subject:e.title,date:e.start.format("YYYY-MM-DD"),start:e.start.format(),end:e.end?e.end.format():e.start.add(2,"hours").format(),backgroundColor:e.backgroundColor,borderColor:e.borderColor,user_id:e.user_id,patient_id:e.patient_id,id:e.id};o("PUT","/medic/appointments/"+a.id,a,t)}function l(e){o("DELETE","/medic/appointments/"+e+"/delete",{idRemove:e})}function s(){var t=$("#new-event").val(),a=$(".search-patients").val();if(0!=t.length&&0!=a.length){var n=$("<div />");n.css({"background-color":f,"border-color":f,color:"#fff"}).addClass("external-event"),n.attr("data-patient",$(".search-patients").val()),n.attr("data-doctor",$("input[name=user_id]").val()),n.html(""),n.html(t+" - "+$(".search-patients").text()),$("#external-events").prepend(n),e(n),$("#new-event").val(""),$(".search-patients").val("").trigger("change"),$(".search-patients").text("").trigger("change")}}e($("#external-events div.external-event")),t(),a();var u=new Date,f=(u.getDate(),u.getMonth(),u.getFullYear(),"#3c8dbc");$("#color-chooser-btn");$("#color-chooser > li > a").click(function(e){e.preventDefault(),f=$(this).css("color"),$("#add-new-event").css({"background-color":f,"border-color":f})}),$("#new-event").keypress(function(e){13==e.which&&s()}),$("#add-new-event").click(function(e){e.preventDefault(),s()}),$(".search-patients").select2({placeholder:"Buscar paciente",ajax:{url:"/medic/patients/list",dataType:"json",delay:250,data:function(e){return{q:e.term}},processResults:function(e){var t=[];return $.each(e.data,function(e,a){item={id:a.id,text:a.first_name},t.push(item)}),{results:t}}}})});