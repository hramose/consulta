$(function(){function a(a){a.each(function(){var a={title:$.trim($(this).text()),user_id:$(this).data("doctor"),patient_id:$(this).data("patient"),created_by:$(this).data("createdby")};$(this).data("eventObject",a),$(this).draggable({zIndex:1070,revert:!0,revertDuration:0})})}function e(){$.ajax({type:"GET",url:"/medics/"+$('input[name="medic_id"]').val()+"/appointments/list",data:{},success:function(a){var e=[];$.each(a,function(a,t){t.allDay=parseInt(t.allDay),0!=t.patient_id&&t.created_by==$('input[name="created_by"]').val()||(t.rendering="background"),e.push(t)}),t(e)},error:function(){}})}function t(a){$("#calendar").fullCalendar({locale:"es",defaultView:"agendaWeek",timeFormat:"h(:mm)a",header:{left:"prev,next today",center:"title",right:"month,agendaWeek,agendaDay"},events:a,forceEventDuration:!0,defaultTimedEventDuration:"01:00:00",editable:!1,droppable:!0,eventOverlap:!1,drop:function(a,e){var t=$(this).data("eventObject"),n=$.extend({},t);n.start=a,n.allDay=!1,n.backgroundColor=$(this).css("background-color"),n.borderColor=$(this).css("border-color"),n.overlap=!1;var r=$("#calendar").fullCalendar("renderEvent",n,!0)[0]._id;d(n,r)},eventResize:function(a,e,t){o(a,t)},eventDrop:function(a,e,t){o(a,t)},eventRender:function(a,e){a.created_by==$('input[name="created_by"]').val()&&(e.append("<span class='closeon fa fa-trash'></span>"),e.append("<span class='appointment-details' ></span>"),e.find(".closeon").click(function(){l(a._id,a)})),"background"==a.rendering&&e.append("<h3>"+a.title+"</h3>"),e.append('<div data-createdby="'+a.created_by+'"></div>'),e.append('<div data-id="'+a.id+'"></span>'),a.patient_id&&a.patient&&e.find(".appointment-details").popover({title:"Cita con el Dr. "+a.user.name,placement:"top",html:!0,container:"#calendar",trigger:"click focus",content:"Fecha: "+a.start.format("YYYY-MM-DD")+" <br>De: "+a.start.format("HH:mm")+" a: "+a.end.format("HH:mm")+"<br>Paciente: "+a.patient.first_name+" "+a.patient.last_name})}})}function n(a){var e=$("#calendar").fullCalendar("clientEvents");for(i in e)if(a.end>e[i].start._i&&a.start<e[i].end._i)return!0;return!1}function r(a,e,t,n){$.ajax({type:a||"POST",url:e,data:t,success:function(e){if("POST"==a&&($("#calendar").fullCalendar("removeEvents",t.idRemove),e.allDay=parseInt(e.allDay),e.allDay?l(e.id):($("#calendar").fullCalendar("renderEvent",e,!0),$("#myModal").modal({backdrop:"static",show:!0}),$("#myModal").find(".btn-finalizar-cita").attr("data-appointment",e.id).show(),$("#myModal").find(".btn-cancelar-cita").attr("data-appointment",e.id).show())),"DELETE"==a){if(e)return $("#infoBox").addClass("alert-danger").html("No se puede eliminar consulta ya que se encuentra iniciada!!").show(),void setTimeout(function(){$("#infoBox").removeClass("alert-danger").hide()},3e3);$("#calendar").fullCalendar("removeEvents",t.idRemove),$("#myModal").find(".btn-finalizar-cita").attr("data-appointment",""),$("#myModal").find(".btn-cancelar-cita").attr("data-appointment","")}if("PUT"==a){if(""==e)return $("#infoBox").addClass("alert-danger").html("No se puede cambiar de dia la consulta ya que se encuentra iniciada!!").show(),setTimeout(function(){$("#infoBox").removeClass("alert-danger").hide()},3e3),void n();$("#calendar").fullCalendar("removeEvents",t.id),e.allDay=parseInt(e.allDay),$("#calendar").fullCalendar("renderEvent",e,!0)}},error:function(){}})}function d(a,e){var t={title:a.title,date:a.start.format("YYYY-MM-DD"),start:a.start.format(),end:a.end?a.end.format():a.start.add(1,"hours").format(),backgroundColor:a.backgroundColor,borderColor:a.borderColor,user_id:a.user_id,patient_id:a.patient_id?a.patient_id:0,created_by:a.created_by,idRemove:e,allDay:0};n(t)&&(t.allDay=1),r("POST","/medics/appointments",t)}function o(a,e){var t={subject:a.title,date:a.start.format("YYYY-MM-DD"),start:a.start.format(),end:a.end?a.end.format():a.start.add(2,"hours").format(),backgroundColor:a.backgroundColor,borderColor:a.borderColor,user_id:a.user_id,patient_id:a.patient_id,created_by:a.created_by,id:a.id,allDay:0};r("PUT","/medics/appointments/"+t.id,t,e)}function l(a){r("DELETE","/medics/appointments/"+a+"/delete",{idRemove:a})}$("body").on("click",function(a){$('[data-toggle="popover"],[data-original-title]').each(function(){$(this).is(a.target)||0!==$(this).has(a.target).length||0!==$(".popover").has(a.target).length||((($(this).popover("hide").data("bs.popover")||{}).inState||{}).click=!1)})}),a($("#external-events div.external-event")),e();var c=new Date;c.getDate(),c.getMonth(),c.getFullYear();$(".btn-finalizar-cita").on("click",function(a){var e=$("#myModal").find(".widget-user-2").attr("data-patient"),t=$(this).attr("data-appointment"),n=$("#myModal").find(".widget-user-2").attr("data-title");$.ajax({type:"PUT",url:"/medics/appointments/"+t,data:{patient_id:e,title:"Cita - "+n},success:function(a){$("#myModal").modal("hide"),$("#calendar").fullCalendar("removeEvents",a.id),a.allDay=parseInt(a.allDay),$("#calendar").fullCalendar("renderEvent",a,!0)},error:function(){}})}),$("#myModal").on("click",".btn-cancelar-cita",function(a){var e=$(this).attr("data-appointment");$.ajax({type:"DELETE",url:"/medics/appointments/"+e+"/delete",data:{id:e},success:function(a){$("#calendar").fullCalendar("removeEvents",e),$("#myModal").modal("hide")},error:function(){}})})});