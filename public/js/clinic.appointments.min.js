$(function(){function a(a){a.each(function(){var a={title:$.trim($(this).text()),office_id:$(this).data("office"),patient_id:$(this).data("patient"),start:moment(),end:moment(),backgroundColor:$(this).css("background-color"),borderColor:$(this).css("border-color")};$(this).data("event",a),$(this).draggable({zIndex:1070,revert:!0,revertDuration:0})})}function e(){$.ajax({type:"GET",url:"/clinic/appointments/list?medic="+$("#calendar").data("medic"),data:{},success:function(a){var e=[];$.each(a,function(a,t){t.allDay=parseInt(t.allDay),0==t.patient_id&&(t.rendering="background"),e.push(t)}),t(e)},error:function(){}})}function t(a){m.fullCalendar({locale:"es",defaultView:"agendaWeek",timeFormat:"h(:mm)a",header:{left:"prev,next today",center:"title",right:"month,agendaWeek,agendaDay"},events:a,forceEventDuration:!0,slotDuration:g,defaultTimedEventDuration:g,editable:!0,droppable:!0,eventOverlap:!1,businessHours:{dow:D,start:h,end:v},eventConstraint:"businessHours",minTime:h,maxTime:v,scrollTime:h,nowIndicator:!0,timezone:"local",allDaySlot:!1,select:function(a,e,t,n){if("month"===n.name)return $("#calendar").fullCalendar("gotoDate",u),$("#calendar").fullCalendar("changeView","agendaWeek"),!1;var o=new Date;return a<o||$(t.target).hasClass("fc-nonbusiness")?($("#infoBox").addClass("alert-danger").html("Hora no permitida!. No puedes selecionar horas pasadas o fuera del horario de atención").show(),setTimeout(function(){$("#infoBox").removeClass("alert-danger").html("").hide()},3e3),m.fullCalendar("unselect"),!1):($("#myModal").modal({backdrop:"static",show:!0}),$("#myModal").find("#modal-new-event").attr("data-modaldate",a.format()),$("#myModal").find("#modal-new-event").attr("data-modaldate-end",e.format()),$("#myModal").find(".modal-body").attr("data-modaldate",a.format()),$("#myModal").find(".modal-body").attr("data-modaldate-end",e.format()),void $("#myModal").find(".modal-body").attr("data-date",a.format("dddd, MMMM Do YYYY")).attr("data-hour",a.format("hh:mm a")))},drop:function(a,e){var t=new Date;if(a<t)return $("#infoBox").addClass("alert-danger").html("Hora no permitida!. No puedes selecionar horas pasadas o fuera del horario de atención").show(),setTimeout(function(){$("#infoBox").removeClass("alert-danger").html("").hide()},3e3),!1;var n=$(this).data("event"),o=$.extend({},n);o.start=a,o.allDay=!1,o.backgroundColor=$(this).css("background-color"),o.borderColor=$(this).css("border-color"),o.overlap=!1},eventReceive:function(a){var e=new Date;return a.start<e?($("#calendar").fullCalendar("removeEvents",a._id),!1):void r(a,a._id)},eventResize:function(a,e,t,n){d(a,t)},eventDrop:function(a,e,t){d(a,t)},eventRender:function(a,e){if(e.hasClass("fc-nonbusiness"))return $("#infoBox").addClass("alert-danger").html("Hora no permitida!. No puedes selecionar horas pasadas o fuera del horario de atención").show(),setTimeout(function(){$("#infoBox").removeClass("alert-danger").html("").hide()},3e3),!1;if(e.append("<span class='appointment-details' ></span>"),"background"==a.rendering&&e.append('<span class="title-bg-event">'+a.title+"</span>"),e.append('<div data-createdby="'+a.created_by+'"></div>'),a.patient_id&&a.patient){var t="";if(a.office){var n=a.office;t="en la "+n.type+" "+n.name+" <br>Dirección: "+n.address+", "+n.province+', Tel: <a href="tel:'+n.phone+'">'+n.phone+"</a><br>"}e.find(".appointment-details").click(function(){swal({title:"Cita con el Paciente "+a.patient.first_name+" "+a.patient.last_name,html:"Fecha: "+a.start.format("YYYY-MM-DD")+" De: "+a.start.format("HH:mm")+" a: "+a.end.format("HH:mm")+" <br>"+t,showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",cancelButtonText:"Ok",confirmButtonText:"Eliminar cita"}).then(function(){var e=l(a._id,a);e&&swal("Cita cancelada!","Tu cita ha sido eliminada del calendario.","success")},function(a){})})}else{var t="",o=a.title,r="Fecha: "+a.start.format("YYYY-MM-DD")+" De: "+a.start.format("HH:mm")+" a: "+a.end.format("HH:mm")+t;if(a.office){var n=a.office;t="<br>Dirección: "+n.address+", "+n.province+" <br>",o="Este horario está reservado para atención en la "+n.type+" "+n.name,r="Favor llamar a este número: "+n.phone+" <br> Fecha: "+a.start.format("YYYY-MM-DD")+" De: "+a.start.format("HH:mm")+" a: "+a.end.format("HH:mm")+t}e.find(".appointment-details").click(function(){swal({title:o,html:r,showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",cancelButtonText:"Ok",confirmButtonText:"Eliminar!"}).then(function(){deleteSchedule(a._id,a),swal("Evento eliminado!","Tu evento ha sido eliminado del calendario.","success")},function(a){})})}},dayClick:function(a,e,t){if("month"===t.name)return $("#calendar").fullCalendar("gotoDate",a),$("#calendar").fullCalendar("changeView","agendaWeek"),!1;var n=new Date;return a<n||$(e.target).hasClass("fc-nonbusiness")?($("#infoBox").addClass("alert-danger").html("Hora no permitida!. No puedes selecionar horas pasadas o fuera del horario de atención").show(),setTimeout(function(){$("#infoBox").removeClass("alert-danger").html("").hide()},3e3),!1):!$(e.target).parent("div").hasClass("fc-bgevent")&&($("#myModal").modal({backdrop:"static",show:!0}),$("#myModal").find("#modal-new-event").attr("data-modaldate",a.format()),$("#myModal").find(".modal-body").attr("data-modaldate",a.format()),void $("#myModal").find(".modal-body").attr("data-date",a.format("dddd, MMMM Do YYYY")).attr("data-hour",a.format("hh:mm a")))}})}function n(a){var e=$("#calendar").fullCalendar("clientEvents");for(i in e)if(a.idRemove!=e[i]._id&&a.end>e[i].start._i&&a.start<e[i].end._i)return!0;return!1}function o(a,e,t,n){$("body").addClass("loading"),$.ajax({type:a||"POST",url:e,data:t,success:function(e){if($("body").removeClass("loading"),"POST"==a){if($("#calendar").fullCalendar("removeEvents",t.idRemove),!e)return $("#infoBox").addClass("alert-danger").html("No se pudo crear la consulta!!").show(),void setTimeout(function(){$("#infoBox").removeClass("alert-danger").hide()},3e3);e.allDay=parseInt(e.allDay),e.allDay?prog_schedule?deleteSchedule(e.id):l(e.id):$("#calendar").fullCalendar("renderEvent",e,!0)}if("DELETE"==a){if(e)return $("#infoBox").addClass("alert-danger").html("No se puede eliminar consulta ya que se encuentra iniciada!!").show(),setTimeout(function(){$("#infoBox").removeClass("alert-danger").hide()},3e3),e;$("#calendar").fullCalendar("removeEvents",t.idRemove)}if("PUT"==a){if(""==e)return $("#infoBox").addClass("alert-danger").html("No se puede cambiar de dia la consulta ya que se encuentra iniciada!!").show(),setTimeout(function(){$("#infoBox").removeClass("alert-danger").hide()},3e3),void n();$("#calendar").fullCalendar("removeEvents",t.id),e.allDay=parseInt(e.allDay),$("#calendar").fullCalendar("renderEvent",e,!0)}},error:function(){$("body").removeClass("loading")}})}function r(a,e){var t={title:a.title,date:a.start.format("YYYY-MM-DD"),start:a.start.stripZone().format(),end:a.end?a.end.stripZone().format():a.start.add(y,b).stripZone().format(),backgroundColor:a.backgroundColor,borderColor:a.borderColor,office_id:a.office_id,patient_id:a.patient_id?a.patient_id:0,user_id:a.user_id,idRemove:e,office_info:a.office_info?a.office_info:"",allDay:0};n(t)&&(t.allDay=1),o("POST","/clinic/appointments",t)}function d(a,e){var t={date:a.start.format("YYYY-MM-DD"),start:a.start.stripZone().format(),end:a.end?a.end.stripZone().format():a.start.add(y,b).stripZone().format(),patient_id:a.patient_id,id:a.id,office_info:a.office_info,allDay:a.allDay};o("PUT","/clinic/appointments/"+t.id,t,e)}function l(a){o("DELETE","/clinic/appointments/"+a+"/delete",{idRemove:a})}function s(){var a="#3c8dbc",e=$("#modal-new-event").val(),t=$(".modal-body").find(".widget-user-2").attr("data-patient"),n=$(".modal-body").find(".widget-user-2").attr("data-title"),o=$(".modal-body").find(".widget-user-2").attr("data-office"),i=$("#calendar").attr("data-medic"),d=$.fullCalendar.moment($("#modal-new-event").attr("data-modaldate")),l=$("#modal-new-event").attr("data-modaldate-end")?$.fullCalendar.moment($("#modal-new-event").attr("data-modaldate-end")):"";if(0!=t.length&&o){var s={title:$.trim(e+" - "+n),user_id:i,patient_id:t,office_id:o},c=s,m=$.extend({},c);if(m.start=d,l&&(m.end=l),d.isValid()){m.allDay=!1,m.backgroundColor=a,m.borderColor=a,m.overlap=!1;var f=$("#calendar").fullCalendar("renderEvent",m,!0)[0]._id;r(m,f)}$("#modal-new-event").val(""),$("#myModal").find("#modal-new-event").attr("data-modaldate",""),$("#myModal").modal("hide")}}var c={Android:function(){return navigator.userAgent.match(/Android/i)},BlackBerry:function(){return navigator.userAgent.match(/BlackBerry/i)},iOS:function(){return navigator.userAgent.match(/iPhone|iPad|iPod/i)},Opera:function(){return navigator.userAgent.match(/Opera Mini/i)},Windows:function(){return navigator.userAgent.match(/IEMobile/i)},any:function(){return c.Android()||c.BlackBerry()||c.iOS()||c.Opera()||c.Windows()}};c.any()&&($(".box-create-appointment").hide(),$(".box-offices").hide()),$(".dropdown-toggle").dropdown(),a($("#external-events div.external-event"));var m=$("#calendar");e();var u=new Date,p=u.getDate(),h=(u.getMonth(),u.getFullYear(),m.attr("data-minTime")?m.attr("data-minTime"):"06:00:00"),v=m.attr("data-maxTime")?m.attr("data-maxTime"):"18:00:00",g=$("#selectSlotDuration").val()?$("#selectSlotDuration").val():m.attr("data-slotDuration"),y="00"==g.split(":")[1]?g.split(":")[0]:g.split(":")[1],b="00"==g.split(":")[1]?"hours":"minutes",C=m.attr("data-freeDays")?JSON.parse(m.attr("data-freeDays")):[],D=[1,2,3,4,5,6,0];for(p in D)for(f in C)if(C[f]==D[p]){var w=D.indexOf(D[p]);w>-1&&D.splice(w,1)}$(".btn-finalizar-cita").click(function(a){a.preventDefault(),s()}),$(".modal-search-patients").select2({placeholder:"Buscar paciente",ajax:{url:"/medic/patients/list",dataType:"json",delay:250,data:function(a){return{q:a.term}},processResults:function(a){$(".modal-search-patients").empty();var e=[];return $.each(a.data,function(a,t){item={id:t.id,text:t.first_name},e.push(item)}),{results:e}}}}),$("#myModal").on("shown.bs.modal",function(a){var e=$(this).find(".modal-body").attr("data-date"),t=$(this).find(".modal-body").attr("data-hour"),n=$(this);n.find(".modal-title").html('Crear cita para el  <span class="label bg-yellow">'+e+'</span> a las <span class="label bg-yellow">'+t+"</span>")})});